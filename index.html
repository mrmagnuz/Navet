<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>NAVET | Live-tavla</title>
    <link href="https://fonts.googleapis.com/css2?family=Amatic+SC:wght@700&family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --navet-green: #49a441; --navet-dark: #1D1D1B; }
        body {
            font-family: 'Montserrat', sans-serif;
            background: #eee url('https://www.navet.com/wp-content/uploads/2023/03/bg3.png') no-repeat center center fixed;
            background-size: cover; margin: 0; padding: 0; height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
        }
        header {
            padding: 15px 40px; display: flex; justify-content: space-between; align-items: center;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px);
            border-bottom: 3px solid var(--navet-green); z-index: 1000;
        }
        .logo-img { height: 50px; }
        .header-title { font-size: 1.6rem; font-weight: 900; text-transform: uppercase; }
        #clock { font-size: 2.5rem; font-weight: 900; }
        .columns-container { display: flex; padding: 10px 20px; gap: 15px; flex-shrink: 0; }
        .column { flex: 1; display: flex; flex-direction: column; }
        .column-header {
            font-family: 'Amatic SC', cursive; font-size: 1.8rem; text-align: center;
            background: var(--navet-dark); color: white; padding: 5px; border-radius: 8px 8px 0 0; margin-bottom: 5px;
        }
        .departure-list { display: flex; flex-direction: column; gap: 4px; min-height: 250px; }
        .departure-row {
            background: rgba(255, 255, 255, 0.95); display: flex; align-items: center; padding: 6px 12px;
            border-radius: 8px; border-right: 6px solid var(--navet-green);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); min-height: 55px;
        }
        .line-badge { 
            min-width: 45px; height: 45px; display: flex; justify-content: center; align-items: center;
            font-weight: 900; border-radius: 6px; margin-right: 12px; color: white; background: #333; font-size: 1.1rem;
        }
        .dest-wrapper { flex-grow: 1; overflow: hidden; }
        .destination { font-size: 0.9rem; font-weight: 900; text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .platform { font-size: 0.75rem; color: #666; font-weight: 700; }
        .time-area { text-align: right; min-width: 60px; }
        .eta { font-size: 1.5rem; font-weight: 900; color: var(--navet-green); line-height: 1; }
        #map { flex-grow: 1; margin: 10px 20px; border-radius: 15px; border: 3px solid var(--navet-dark); z-index: 1; }
        footer { padding: 8px 40px; background: var(--navet-dark); color: white; display: flex; justify-content: space-between; font-weight: 700; font-size: 0.9rem; }
        #debug-log { font-size: 0.75rem; opacity: 0.8; color: #ffcc00; }
        
        /* CSS f√∂r Easter Egg-texten */
        .easter-egg {
            color: var(--navet-green);
            font-size: 0.7em;
            font-style: italic;
            text-transform: none; /* Ser till att texten √§r gemener f√∂r att sticka ut fr√•n orten */
            font-weight: 700;
            margin-left: 6px;
        }
    </style>
</head>
<body>

<header>
    <img src="https://fssc.se/wp-content/uploads/2023/09/Logotyp-svart-768x290.png" class="logo-img">
    <div class="header-title">H√•llplatser Simonsland & Resecentrum</div>
    <div id="clock">00:00</div>
</header>

<div class="columns-container">
    <div class="column">
        <div class="column-header">Simonsland (L√§ge A)</div>
        <div id="board-simonsland-in" class="departure-list">Laddar...</div>
    </div>
    <div class="column">
        <div class="column-header">Simonsland (√ñvriga)</div>
        <div id="board-simonsland-out" class="departure-list">Laddar...</div>
    </div>
    <div class="column">
        <div class="column-header">Resecentrum (T√•g & Region)</div>
        <div id="board-resecentrum" class="departure-list">Laddar...</div>
    </div>
</div>

<div id="map"></div>

<footer>
    <div>UPPLEV. L√ÑR. UTFORSKA.</div>
    <div id="debug-log">System startar...</div>
</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // --- API NYCKLAR ---
    const V_KEY = 'QlypIiMS1PaWXe5Nu1HWl1bCYU8a';
    const V_SECRET = 'OfZF4rSB2MaWEx1qgTtuMVMue70a';
    const TV_KEY = '8b529134e7844ac48320577d18d0237e';
    const PROXY = 'https://corsproxy.io/?';

    function setDebug(msg) { document.getElementById('debug-log').innerText = msg; }

    // --- KARTA OCH RUTTER ---
    const NAVET_ENTRE = [57.724285, 12.936959];
    const STOP_SIMONSLAND = [57.72557, 12.93841];
    const STOP_RESECENTRUM = [57.720733, 12.932754];

    const map = L.map('map', { zoomControl: false }).setView([57.7225, 12.9355], 15);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

    L.polyline([NAVET_ENTRE, [57.7245, 12.9378], [57.7250, 12.9382], STOP_SIMONSLAND], {color: '#1D1D1B', weight: 4, dashArray: '5, 8', opacity: 0.6}).addTo(map);
    L.polyline([NAVET_ENTRE, [57.723437,12.936337], [57.723231,12.936766], [57.722543,12.935414], [57.722016,12.935114], [57.722051,12.934771], [57.72185,12.934277], [57.721134,12.933049], [57.720933,12.932829], STOP_RESECENTRUM], {color: '#1D1D1B', weight: 4, dashArray: '5, 8', opacity: 0.6}).addTo(map);

    L.circleMarker(NAVET_ENTRE, { radius: 8, fillColor: "#49a441", color: "#fff", weight: 3, fillOpacity: 1 }).addTo(map).bindTooltip("DU √ÑR H√ÑR", {permanent: true, direction: 'top'});
    L.circleMarker(STOP_SIMONSLAND, { radius: 6, fillColor: "#1D1D1B", color: "#fff", weight: 2, fillOpacity: 1 }).addTo(map).bindTooltip("Simonsland", {permanent: true, direction: 'right'});
    L.circleMarker(STOP_RESECENTRUM, { radius: 6, fillColor: "#1D1D1B", color: "#fff", weight: 2, fillOpacity: 1 }).addTo(map).bindTooltip("Resecentrum", {permanent: true, direction: 'left'});

    const vehicleLayer = L.layerGroup().addTo(map);

    // ==========================================
    // NAVETS HEMLIGA EASTER EGGS ü•öüî¨
    // ==========================================
    const easterEggs = {
        "G√ñTEBORG": ["‚Äì f√∂r att leta efter Glenn", "‚Äì dags att ber√§kna vindmotst√•ndet p√• Avenyn", "‚Äì medtag egen paraply-krockkudde", "‚Äì ett utm√§rkt tillf√§lle att r√§kna sp√•rvagnar"],
        "G√ñTEBORG C": ["‚Äì f√∂r att leta efter Glenn", "‚Äì dags att ber√§kna vindmotst√•ndet p√• Avenyn", "‚Äì medtag egen paraply-krockkudde", "‚Äì ett utm√§rkt tillf√§lle att r√§kna sp√•rvagnar"],
        "BOR√ÖS": ["‚Äì kom ih√•g att f√§lla ut g√§larna", "‚Äì dags att m√§ta regndropparnas exakta volym", "‚Äì Pinocchios byxor beh√∂ver tv√§ttas", "‚Äì perfekt f√∂r en studie i rondell-navigering"],
        "UDDEVALLA": ["‚Äì f√∂r att bygga en ub√•t av sn√§ckskal", "‚Äì dags att utmana en fiskm√•s i schack", "‚Äì Bohusl√§ns inofficiella rymdbas"],
        "VISKAFORS": ["‚Äì f√∂r att spana efter Viskan-odjuret", "‚Äì dags att m√§ta friktionen i gummisulor", "‚Äì skogen kallar: krama ett tr√§d!"],
        "KINNARUMMA": ["‚Äì orten med det roligaste namnet att s√§ga snabbt", "‚Äì dags att r√§kna antalet epatraktorer", "‚Äì d√§r tiden bevisligen g√•r lite l√•ngsammare"],
        "KINNA": ["‚Äì f√∂r att rulla in dig i 14 meter tyg", "‚Äì dags att sy en rymddr√§kt av gamla gardiner", "‚Äì varning: extrem risk f√∂r tr√•dtrazzel", "‚Äì unders√∂k bomullens aerodynamik"],
        "SKENE": ["‚Äì f√∂r att rulla in dig i 14 meter tyg", "‚Äì dags att sy en rymddr√§kt av gamla gardiner", "‚Äì varning: extrem risk f√∂r tr√•dtrazzel", "‚Äì unders√∂k bomullens aerodynamik"],
        "SVENLJUNGA": ["‚Äì f√∂r att koka kaffe p√• √Ñtran-vatten", "‚Äì dags att uppfinna en ny typ av papperskorg", "‚Äì d√§r moped √§r det enda sanna f√§rdmedlet"],
        "FRISTAD": ["‚Äì dags att bygga ett fort av kl√§dh√§ngare", "‚Äì f√∂r att m√§ta ljudets hastighet √∂ver sj√∂n", "‚Äì medtag egen picknickkorg och f√∂rstoringsglas"],
        "TRANEMO": ["‚Äì f√∂r att testa h√•llfastheten i glasrutor", "‚Äì dags att starta en k√∂r med tranor", "‚Äì orten d√§r sexkanten √§r den heligaste geometriska formen"],
        "ULRICEHAMN": ["‚Äì f√∂r att √•ka l√§ngdskidor p√• asfalten", "‚Äì unders√∂k friktionen mellan byxa och pulkabacke", "‚Äì varning f√∂r branta backar och pl√∂tslig mj√∂lksyra"],
        "SANDARED": ["‚Äì f√∂r att ber√§kna sandkornens totala densitet", "‚Äì dags att bygga sandslott i stormvind", "‚Äì simf√∂tter och skyddsglas√∂gon rekommenderas"],
        "HERRLJUNGA": ["‚Äì dags att provsmaka 40 liter √§ppelcider", "‚Äì analysera ciderns koldioxidbubblor i mikroskop", "‚Äì f√∂r att byta t√•g... igen", "‚Äì se upp f√∂r fallande √§pplen fr√•n skyn"],
        "VARBERG": ["‚Äì f√∂r att m√§ta havets salthalt med tungan", "‚Äì perfekt f√∂r en f√§ltstudie i m√•sars st√∂rtflygning", "‚Äì dags att surfa p√• en br√§da gjord av ost", "‚Äì f√§stningens murar beh√∂ver inspekteras"],
        "√ñXNERED": ["‚Äì 'Lilla Paris' beh√∂ver fler baguetter", "‚Äì f√∂r att leta efter det mytomspunna V√§nern-odjuret", "‚Äì dags att m√§ta vattenst√•ndet med tumstock"],
        "V√ÑNERSBORG": ["‚Äì 'Lilla Paris' beh√∂ver fler baguetter", "‚Äì f√∂r att leta efter det mytomspunna V√§nern-odjuret", "‚Äì dags att m√§ta vattenst√•ndet med tumstock"],
        "HORRED": ["‚Äì dags att v√§va en matta av hall√§ndskt gr√§s", "‚Äì varning f√∂r pl√∂tsliga skurar av garn", "‚Äì f√∂r att studera hur snabbt en traktor faktiskt kan √•ka"],
        "VEDDIGE": ["‚Äì f√∂r att spela ishockey p√• gr√§s", "‚Äì den hall√§ndska gr√§nsen √§r n√•dd!", "‚Äì dags att unders√∂ka kornas matsm√§ltning"],
        "SVANEHOLM": ["‚Äì f√∂r att infiltrera svanarnas hemliga bas", "‚Äì dags att bygga en flotte av vass och tejp", "‚Äì medtag egen fj√§derboa f√∂r kamouflage"],
        "G√ÑLLSTAD": ["‚Äì f√∂r att testa elasticiteten i 100 par byxor", "‚Äì trik√•-paradiset kallar!", "‚Äì ett ypperligt tillf√§lle att k√∂pa kl√§der tills du spricker"],
        "ERIKSTORP": ["‚Äì dags att unders√∂ka om bollarna faktiskt byggs h√§r", "‚Äì f√∂r att testa bakl√§ngesg√•ng genom byn", "‚Äì perfekt aerodynamik f√∂r drakflygning fr√•n fj√§llet"],
        "BOLLEBYGD": ["‚Äì dags att unders√∂ka om bollarna faktiskt byggs h√§r", "‚Äì f√∂r att testa bakl√§ngesg√•ng genom byn", "‚Äì perfekt aerodynamik f√∂r drakflygning fr√•n fj√§llet"],
        "L√ÑNGHEM": ["‚Äì dags att sp√∂kjaga med v√§rmekamera p√• Torpa", "‚Äì f√∂r att m√§ta exakt hur 'l√•ngt hem' det faktiskt √§r", "‚Äì testa h√•llfastheten i medeltida stenmurar", "‚Äì ett utm√§rkt tillf√§lle f√∂r ett djupdyk i √Ösunden"],
        "KALMAR C": ["‚Äì f√∂r att bygga ett slott av kroppkakor", "‚Äì dags att leta efter den f√∂rsvunna unionen", "‚Äì dags att testa brons aerodynamik i sidvind", "‚Äì unders√∂k hur m√•nga Gustav Vasa-kopior som ryms p√• slottet"],
        "KALMAR": ["‚Äì f√∂r att bygga ett slott av kroppkakor", "‚Äì dags att leta efter den f√∂rsvunna unionen", "‚Äì dags att testa brons aerodynamik i sidvind", "‚Äì unders√∂k hur m√•nga Gustav Vasa-kopior som ryms p√• slottet"]
    };

    function getEasterEgg(destination) {
        const destUpper = destination.toUpperCase();
        if (easterEggs[destUpper]) {
            const eggs = easterEggs[destUpper];
            const randomEgg = eggs[Math.floor(Math.random() * eggs.length)];
            return `<span class="easter-egg">${randomEgg}</span>`;
        }
        return "";
    }
    // ==========================================


    let accessToken = "";

    async function getToken() {
        try {
            const res = await fetch(PROXY + encodeURIComponent('https://ext-api.vasttrafik.se/token'), {
                method: 'POST',
                headers: { 'Authorization': 'Basic ' + btoa(V_KEY + ':' + V_SECRET), 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'grant_type=client_credentials'
            });
            const data = await res.json();
            accessToken = data.access_token;
        } catch (e) { setDebug("Kunde inte h√§mta nyckel fr√•n V√§sttrafik."); }
    }

    async function update() {
        if (!accessToken) await getToken();
        if (!accessToken) return;

        let statusText = "VT OK.";

        // --- 1. H√ÑMTA SIMONSLAND ---
        try {
            const urlS = `https://ext-api.vasttrafik.se/pr/v4/stop-areas/9021014082035000/departures?limit=100&timeSpan=1440&maxDeparturesPerLineAndDirection=4`;
            const resS = await fetch(PROXY + encodeURIComponent(urlS), { headers: { 'Authorization': 'Bearer ' + accessToken } });
            if (resS.ok) {
                const dataS = await resS.json();
                const renderBoard = (platform, elId) => {
                    let html = "", count = 0;
                    if (dataS.results) {
                        for (let dep of dataS.results) {
                            const isA = dep.stopPoint && dep.stopPoint.platform === "A";
                            const match = platform === "A" ? isA : !isA;
                            if (match && count < 4) {
                                html += createRow(dep, false);
                                count++;
                            }
                        }
                    }
                    document.getElementById(elId).innerHTML = html || "<div style='padding:10px;'>Inga avg√•ngar funna.</div>";
                };
                renderBoard("A", "board-simonsland-in");
                renderBoard("B", "board-simonsland-out");
            }
        } catch (e) {}

        // --- 2. RESECENTRUM (T√•g & Region) ---
        let combined = [];
        let tvHasData = false;

        // A. T√•g fr√•n Trafikverket 
        try {
            const tvXML = `
                <REQUEST>
                    <LOGIN authenticationkey='${TV_KEY}' />
                    <QUERY objecttype='TrainAnnouncement' schemaversion='1.9' orderby='AdvertisedTimeAtLocation asc' limit='20'>
                        <FILTER>
                            <AND>
                                <OR>
                                    <AND>
                                        <GT name='AdvertisedTimeAtLocation' value='$dateadd(-00:15:00)' />
                                        <LT name='AdvertisedTimeAtLocation' value='$dateadd(14:00:00)' />
                                    </AND>
                                    <GT name='EstimatedTimeAtLocation' value='$now' />
                                </OR>
                                <EQ name='LocationSignature' value='Bs' />
                                <EQ name='ActivityType' value='Avgang' />
                            </AND>
                        </FILTER>
                        <INCLUDE>InformationOwner</INCLUDE>
                        <INCLUDE>AdvertisedTimeAtLocation</INCLUDE>
                        <INCLUDE>EstimatedTimeAtLocation</INCLUDE>
                        <INCLUDE>TrackAtLocation</INCLUDE>
                        <INCLUDE>ToLocation</INCLUDE>
                        <INCLUDE>ProductInformation</INCLUDE>
                    </QUERY>
                </REQUEST>
            `;
            
            const resT = await fetch("https://api.trafikinfo.trafikverket.se/v2/data.json", {
                method: 'POST',
                headers: { 'Content-Type': 'text/xml' }, 
                body: tvXML
            });
            
            if (resT.ok) {
                const dataT = await resT.json();
                if (dataT.RESPONSE && dataT.RESPONSE.RESULT[0].TrainAnnouncement) {
                    const trains = dataT.RESPONSE.RESULT[0].TrainAnnouncement;
                    if (trains.length > 0) {
                        tvHasData = true;
                        statusText += ` TV Laddat.`;
                        trains.forEach(t => {
                            const rowHtml = createTrainRow(t);
                            if(rowHtml) combined.push({ t: new Date(t.EstimatedTimeAtLocation || t.AdvertisedTimeAtLocation), html: rowHtml, isTrain: true });
                        });
                    }
                }
            }
        } catch (e) {}

        // B. Reserv-t√•g fr√•n V√§sttrafik
        if (!tvHasData) {
            try {
                const urlC = `https://ext-api.vasttrafik.se/pr/v4/stop-areas/9021014082010000/departures?limit=30&timeSpan=1440`;
                const resC = await fetch(PROXY + encodeURIComponent(urlC), { headers: { 'Authorization': 'Bearer ' + accessToken } });
                if (resC.ok) {
                    const dataC = await resC.json();
                    if (dataC.results) {
                        dataC.results.forEach(d => {
                            if (d.serviceJourney && d.serviceJourney.line) {
                                const isTrain = d.serviceJourney.line.transportMode === 'train' || d.serviceJourney.line.transportMode === 'rail';
                                if (isTrain) {
                                    const rowHtml = createRow(d, true);
                                    if(rowHtml) combined.push({ t: new Date(d.estimatedTime || d.plannedTime), html: rowHtml, isTrain: true });
                                }
                            }
                        });
                    }
                }
            } catch(e) { }
        }

        // C. Regionbussar
        try {
            const urlB = `https://ext-api.vasttrafik.se/pr/v4/stop-areas/9021014082017000/departures?limit=40&timeSpan=1440&maxDeparturesPerLineAndDirection=5`;
            const resB = await fetch(PROXY + encodeURIComponent(urlB), { headers: { 'Authorization': 'Bearer ' + accessToken } });
            if (resB.ok) {
                const dataB = await resB.json();
                if (dataB.results) {
                    dataB.results.forEach(d => {
                        if (d.serviceJourney && d.serviceJourney.line) {
                            const lineNo = parseInt(d.serviceJourney.line.shortName);
                            if (lineNo > 31 || isNaN(lineNo)) {
                                const rowHtml = createRow(d, false);
                                if(rowHtml) combined.push({ t: new Date(d.estimatedTime || d.plannedTime), html: rowHtml, isTrain: false });
                            }
                        }
                    });
                }
            }
        } catch(e) {}

        // Sortera allt p√• tid
        combined.sort((a,b) => a.t - b.t);
        
        let uniqueCombined = [];
        let prevTime = 0;
        combined.forEach(item => {
            if (item.t.getTime() !== prevTime) {
                uniqueCombined.push(item);
                prevTime = item.t.getTime();
            }
        });

        // Garantera plats f√∂r t√•g!
        let rHtml = "";
        let bCount = 0;
        let tCount = 0;
        const totalTrains = uniqueCombined.filter(x => x.isTrain).length;
        const maxBuses = totalTrains > 0 ? 4 : 7;
        const limitTime = new Date(new Date().getTime() - 60000); 

        uniqueCombined.forEach(item => {
            if (item.t > limitTime && (bCount + tCount) < 7) {
                if (item.isTrain) {
                    rHtml += item.html;
                    tCount++;
                } else if (bCount < maxBuses) {
                    rHtml += item.html;
                    bCount++;
                }
            }
        });

        document.getElementById('board-resecentrum').innerHTML = rHtml || "<div style='padding:10px;'>Inga avg√•ngar funna.</div>";
        setDebug(`${statusText} | Uppdaterad ${new Date().toLocaleTimeString('sv-SE')}`);

        // --- 3. KARTAN ---
        try {
            const resP = await fetch(PROXY + encodeURIComponent('https://ext-api.vasttrafik.se/pr/v4/positions?lowerLeftLat=57.71&lowerLeftLong=12.91&upperRightLat=57.74&upperRightLong=12.96'), {
                headers: { 'Authorization': 'Bearer ' + accessToken }
            });
            if (resP.ok) {
                const pData = await resP.json();
                vehicleLayer.clearLayers();
                pData.forEach(v => {
                    if (v.latitude && v.line) {
                        let label = v.line.shortName || v.line.designation || v.line.name || "?";
                        L.marker([v.latitude, v.longitude], {
                            icon: L.divIcon({ className: '', html: `<div style="background:${v.line.backgroundColor || '#49a441'}; color:white; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:900; border:2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">${label}</div>` })
                        }).addTo(vehicleLayer);
                    }
                });
            }
        } catch(e) {}
    }

    // --- HTML BYGGARE MED EASTER EGGS ---
    function createRow(d, isTrainStyle) {
        try {
            const diff = Math.round((new Date(d.estimatedTime || d.plannedTime) - new Date()) / 60000);
            let name = d.serviceJourney.line.shortName || d.serviceJourney.line.designation || "BUSS";
            let bg = d.serviceJourney.line.backgroundColor || "#333";
            let dest = d.serviceJourney.direction ? d.serviceJourney.direction.split(',')[0] : "OK√ÑND";
            const plat = d.stopPoint && d.stopPoint.platform ? d.stopPoint.platform : "-";
            
            // Kolla om destinationen har ett easter egg!
            const egg = getEasterEgg(dest);
            
            if (isTrainStyle) {
                return `<div class="departure-row" style="border-right-color:#607d8b">
                    <div class="line-badge" style="background:#607d8b; font-size:0.75rem; text-align:center; padding: 2px; line-height:1;">V√ÑSTT√ÖG</div>
                    <div class="dest-wrapper">
                        <div class="destination">MOT ${dest}${egg}</div>
                        <div class="platform">Sp√•r ${plat}</div>
                    </div>
                    <div class="time-area"><span class="eta">${diff <= 0 ? 'NU' : diff}</span>${diff > 0 ? '<span style="font-size:0.6rem;display:block;font-weight:700">MIN</span>' : ''}</div>
                </div>`;
            }

            return `<div class="departure-row">
                <div class="line-badge" style="background:${bg}">${name}</div>
                <div class="dest-wrapper">
                    <div class="destination">MOT ${dest}${egg}</div>
                    <div class="platform">L√§ge ${plat}</div>
                </div>
                <div class="time-area"><span class="eta">${diff <= 0 ? 'NU' : diff}</span>${diff > 0 ? '<span style="font-size:0.6rem;display:block;font-weight:700">MIN</span>' : ''}</div>
            </div>`;
        } catch(err) { return ""; }
    }

    function createTrainRow(t) {
        try {
            const timeStr = t.EstimatedTimeAtLocation || t.AdvertisedTimeAtLocation;
            if (!timeStr) return "";
            
            const diff = Math.round((new Date(timeStr) - new Date()) / 60000);
            
            // Trafikverkets databas-√∂vers√§ttning, KAC √∂vers√§tts snyggt till KALMAR C
            const stations = { 'G': 'G√ñTEBORG C', 'HR': 'HERRLJUNGA', 'VV': 'VARBERG', 'UV': 'UDDEVALLA', 'KAC': 'KALMAR C', 'V√ñ': 'V√ÑXJ√ñ' };
            
            let destCode = "OK√ÑND";
            if (t.ToLocation && t.ToLocation.length > 0) {
                if (typeof t.ToLocation[0] === 'string') destCode = t.ToLocation[0];
                else if (t.ToLocation[0].LocationName) destCode = t.ToLocation[0].LocationName;
            }
            
            // √ñvers√§tt koden (T.ex. fr√•n KAC till KALMAR C)
            const dest = stations[destCode.toUpperCase()] || destCode;
            
            // H√§mta easter egg f√∂r den √∂versatta staden
            const egg = getEasterEgg(dest);
            
            let op = "T√ÖG";
            if (t.ProductInformation && t.ProductInformation.length > 0 && t.ProductInformation[0].Description) {
                op = t.ProductInformation[0].Description.substring(0,6).toUpperCase();
            } else if (t.InformationOwner) {
                op = t.InformationOwner.substring(0,6).toUpperCase();
            }
            
            const plat = t.TrackAtLocation || '-';
            
            return `<div class="departure-row" style="border-right-color:#607d8b">
                <div class="line-badge" style="background:#607d8b; font-size:0.75rem; text-align:center; padding: 2px; line-height:1;">${op}</div>
                <div class="dest-wrapper">
                    <div class="destination">MOT ${dest}${egg}</div>
                    <div class="platform">Sp√•r ${plat}</div>
                </div>
                <div class="time-area"><span class="eta">${diff <= 0 ? 'NU' : diff}</span>${diff > 0 ? '<span style="font-size:0.6rem;display:block;font-weight:700">MIN</span>' : ''}</div>
            </div>`;
        } catch(err) { return ""; }
    }

    function updateClock() { document.getElementById('clock').innerText = new Date().toLocaleTimeString('sv-SE', {hour:'2-digit', minute:'2-digit'}); }
    
    // STARTSEKVENS
    updateClock();
    setInterval(updateClock, 1000);
    setInterval(update, 60000); 
    setTimeout(() => { map.invalidateSize(); }, 500);
    update();
</script>
</body>
</html>
