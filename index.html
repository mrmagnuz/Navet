<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>NAVET | Live-tavla</title>
    <link href="https://fonts.googleapis.com/css2?family=Amatic+SC:wght@700&family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --navet-green: #49a441; --navet-dark: #1D1D1B; --vt-red: #E3000F; }
        body {
            font-family: 'Montserrat', sans-serif;
            background: #eee url('https://www.navet.com/wp-content/uploads/2023/03/bg3.png') no-repeat center center fixed;
            background-size: cover; margin: 0; padding: 0; height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
        }
        header {
            padding: 15px 40px; display: flex; justify-content: space-between; align-items: center;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px);
            border-bottom: 3px solid var(--navet-green); z-index: 1000; flex-shrink: 0;
        }
        .logo-img { height: 50px; }
        .header-title { font-size: 1.6rem; font-weight: 900; text-transform: uppercase; }
        #clock { font-size: 2.5rem; font-weight: 900; }
        
        .main-content {
            display: flex; flex-grow: 1; padding: 15px 20px; gap: 20px; overflow: hidden;
        }
        .left-panel {
            flex: 2; display: flex; flex-direction: column; gap: 15px; min-width: 0;
        }
        .simonsland-cols {
            display: flex; gap: 20px; flex-shrink: 0;
        }
        .right-panel {
            flex: 1; display: flex; flex-direction: column; min-width: 0;
        }
        
        .column { flex: 1; display: flex; flex-direction: column; }
        .full-height-col { height: 100%; }
        
        .column-header {
            font-family: 'Amatic SC', cursive; font-size: 1.8rem; text-align: center;
            background: var(--navet-dark); color: white; padding: 5px; border-radius: 8px 8px 0 0; margin-bottom: 5px; flex-shrink: 0;
        }
        
        /* NY STIL FÖR KARTANS RUBRIK */
        .map-wrapper {
            display: flex; flex-direction: column; flex-grow: 1;
        }
        .map-header {
            font-family: 'Amatic SC', cursive; font-size: 1.8rem; text-align: center;
            background: var(--navet-dark); color: white; padding: 5px; border-radius: 12px 12px 0 0; margin-bottom: 0; flex-shrink: 0;
        }
        #map { 
            flex-grow: 1; border-radius: 0 0 12px 12px; border: 3px solid var(--navet-dark); border-top: none; z-index: 1; 
        }

        .departure-list { display: flex; flex-direction: column; gap: 4px; overflow: hidden; }
        .departure-row {
            background: rgba(255, 255, 255, 0.95); display: flex; align-items: center; padding: 6px 12px;
            border-radius: 8px; border-right: 6px solid var(--navet-green);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); min-height: 55px;
        }
        .line-badge { 
            min-width: 45px; height: 45px; display: flex; justify-content: center; align-items: center;
            font-weight: 900; border-radius: 6px; margin-right: 12px; color: white; font-size: 1.1rem;
        }
        .dest-wrapper { flex-grow: 1; overflow: hidden; }
        .destination { font-size: 0.9rem; font-weight: 900; text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .platform { font-size: 0.75rem; color: #666; font-weight: 700; }
        .time-area { text-align: right; min-width: 60px; }
        .eta { font-size: 1.5rem; font-weight: 900; color: var(--navet-green); line-height: 1; }
        
        footer { 
            padding: 8px 40px; background: var(--navet-dark); color: white; display: flex; 
            justify-content: space-between; align-items: center; font-weight: 700; font-size: 0.9rem; flex-shrink: 0; 
        }
        #status-area { display: flex; gap: 15px; align-items: center; }
        #countdown-timer { color: var(--navet-green); font-weight: 900; }
        #debug-log { font-size: 0.75rem; opacity: 0.7; color: #ffcc00; }
        
        .easter-egg { color: var(--navet-green); font-size: 0.7em; font-style: italic; text-transform: none; font-weight: 700; margin-left: 6px; }
    </style>
</head>
<body>

<header>
    <img src="https://fssc.se/wp-content/uploads/2023/09/Logotyp-svart-768x290.png" class="logo-img">
    <div class="header-title">Hållplatser Simonsland & Resecentrum</div>
    <div id="clock">00:00</div>
</header>

<div class="main-content">
    <div class="left-panel">
        <div class="simonsland-cols">
            <div class="column">
                <div class="column-header">Simonsland (Läge A)</div>
                <div id="board-simonsland-in" class="departure-list">Laddar...</div>
            </div>
            <div class="column">
                <div class="column-header">Simonsland (Läge B)</div>
                <div id="board-simonsland-out" class="departure-list">Laddar...</div>
            </div>
        </div>
        
        <div class="map-wrapper">
            <div class="map-header">Här ser du livepositionen på Ettans bussar</div>
            <div id="map"></div>
        </div>
    </div>
    
    <div class="right-panel">
        <div class="column full-height-col">
            <div class="column-header">Resecentrum (Tåg & Region)</div>
            <div id="board-resecentrum" class="departure-list">Laddar...</div>
        </div>
    </div>
</div>

<footer>
    <div>UPPLEV. LÄR. UTFORSKA.</div>
    <div id="status-area">
        <span id="countdown-timer">Uppdaterar om: 30s</span>
        <span style="opacity: 0.3;">|</span>
        <span id="debug-log">System startar...</span>
    </div>
</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const V_KEY = 'QlypIiMS1PaWXe5Nu1HWl1bCYU8a';
    const V_SECRET = 'OfZF4rSB2MaWEx1qgTtuMVMue70a';
    const TV_KEY = '8b529134e7844ac48320577d18d0237e';
    const PROXY = 'https://corsproxy.io/?';

    function setDebug(msg) { document.getElementById('debug-log').innerText = msg; }

    let timeToUpdate = 30;
    setInterval(() => {
        timeToUpdate--;
        if (timeToUpdate < 0) timeToUpdate = 30;
        document.getElementById('countdown-timer').innerText = `Uppdaterar om: ${timeToUpdate}s`;
    }, 1000);

    const NAVET_ENTRE = [57.724285, 12.936959];
    const STOP_SIMONSLAND = [57.72557, 12.93841];
    const STOP_RESECENTRUM = [57.720733, 12.932754];

    const map = L.map('map', { zoomControl: false }).setView(NAVET_ENTRE, 14.5);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

    L.polyline([NAVET_ENTRE, [57.7245, 12.9378], [57.7250, 12.9382], STOP_SIMONSLAND], {color: '#1D1D1B', weight: 4, dashArray: '5, 8', opacity: 0.6}).addTo(map);
    L.polyline([NAVET_ENTRE, [57.723437,12.936337], [57.723231,12.936766], [57.722543,12.935414], [57.722016,12.935114], [57.722051,12.934771], [57.72185,12.934277], [57.721134,12.933049], [57.720933,12.932829], STOP_RESECENTRUM], {color: '#1D1D1B', weight: 4, dashArray: '5, 8', opacity: 0.6}).addTo(map);

    L.circleMarker(NAVET_ENTRE, { radius: 8, fillColor: "#49a441", color: "#fff", weight: 3, fillOpacity: 1 }).addTo(map).bindTooltip("DU ÄR HÄR", {permanent: true, direction: 'left'});
    L.circleMarker(STOP_SIMONSLAND, { radius: 6, fillColor: "#1D1D1B", color: "#fff", weight: 2, fillOpacity: 1 }).addTo(map).bindTooltip("Simonsland", {permanent: true, direction: 'left'});
    L.circleMarker(STOP_RESECENTRUM, { radius: 6, fillColor: "#1D1D1B", color: "#fff", weight: 2, fillOpacity: 1 }).addTo(map).bindTooltip("Resecentrum", {permanent: true, direction: 'left'});

    const vehicleLayer = L.layerGroup().addTo(map);

    function translateTouristDestinations(dest) {
        if (!dest) return "OKÄND";
        let dUpper = dest.toUpperCase();
        if ((dUpper.includes("HÄSSLEHOLMEN") || dUpper.includes("HÄSLLEHOLMEN")) && dUpper.includes("SJUKHUSET")) return "CENTRUM";
        if (dUpper.includes("SJÖBO")) return "KNALLELAND";
        return dest; 
    }

    const easterEggs = {
        "GÖTEBORG": ["– för att leta efter Glenn", "– dags att beräkna vindmotståndet på Avenyn", "– medtag egen paraply-krockkudde", "– ett utmärkt tillfälle att räkna spårvagnar"],
        "GÖTEBORG C": ["– för att leta efter Glenn", "– dags att beräkna vindmotståndet på Avenyn", "– medtag egen paraply-krockkudde", "– ett utmärkt tillfälle att räkna spårvagnar"],
        "UDDEVALLA": ["– för att bygga en ubåt av snäckskal", "– dags att utmana en fiskmås i schack", "– Bohusläns inofficiella rymdbas"],
        "VISKAFORS": ["– för att spana efter Viskan-odjuret", "– dags att mäta friktionen i gummisulor", "– skogen kallar: krama ett träd!"],
        "KINNARUMMA": ["– orten med det roligaste namnet att säga snabbt", "– dags att räkna antalet epatraktorer", "– där tiden bevisligen går lite långsammare"],
        "KINNA": ["– för att rulla in dig i 14 meter tyg", "– dags att sy en rymddräkt av gamla gardiner", "– varning: extrem risk för trådtrazzel", "– undersök bomullens aerodynamik"],
        "SKENE": ["– för att rulla in dig i 14 meter tyg", "– dags att sy en rymddräkt av gamla gardiner", "– varning: extrem risk för trådtrazzel", "– undersök bomullens aerodynamik"],
        "SVENLJUNGA": ["– för att koka kaffe på Ätran-vatten", "– dags att uppfinna en ny typ av papperskorg", "– där moped är det enda sanna färdmedlet"],
        "FRISTAD": ["– dags att bygga ett fort av klädhängare", "– för att mäta ljudets hastighet över sjön", "– medtag egen picknickkorg och förstoringsglas"],
        "TRANEMO": ["– för att testa hållfastheten i glasrutor", "– dags att starta en kör med tranor", "– orten där sexkanten är den heligaste geometriska formen"],
        "ULRICEHAMN": ["– för att åka längdskidor på asfalten", "– undersök friktionen mellan byxa och pulkabacke", "– varning för branta backar och plötslig mjölksyra"],
        "ULRICEHAMN VIA GÄLLSTAD": ["– för att åka längdskidor på asfalten", "– undersök friktionen mellan byxa och pulkabacke", "– varning för branta backar och plötslig mjölksyra"],
        "SANDARED": ["– för att beräkna sandkornens totala densitet", "– dags att bygga sandslott i stormvind", "– simfötter och skyddsglasögon rekommenderas"],
        "HERRLJUNGA": ["– dags att provsmaka 40 liter äppelcider", "– analysera ciderns koldioxidbubblor i mikroskop", "– för att byta tåg... igen", "– se upp för fallande äpplen från skyn"],
        "VARBERG": ["– för att mäta havets salthalt med tungan", "– perfekt för en fältstudie i måsars störtflygning", "– dags att surfa på en bräda gjord av ost", "– fästningens murar behöver inspekteras"],
        "ÖXNERED": ["– 'Lilla Paris' behöver fler baguetter", "– för att leta efter det mytomspunna Vänern-odjuret", "– dags att mäta vattenståndet med tumstock"],
        "VÄNERSBORG": ["– 'Lilla Paris' behöver fler baguetter", "– för att leta efter det mytomspunna Vänern-odjuret", "– dags att mäta vattenståndet med tumstock"],
        "HORRED": ["– dags att väva en matta av halländskt gräs", "– varning för plötsliga skurar av garn", "– för att studera hur snabbt en traktor faktiskt kan åka"],
        "VEDDIGE": ["– för att spela ishockey på gräs", "– den halländska gränsen är nådd!", "– dags att undersöka kornas matsmältning"],
        "SVANEHOLM": ["– för att infiltrera svanarnas hemliga bas", "– dags att bygga en flotte av vass och tejp", "– medtag egen fjäderboa för kamouflage"],
        "GÄLLSTAD": ["– för att testa elasticiteten i 100 par byxor", "– trikå-paradiset kallar!", "– ett ypperligt tillfälle att köpa kläder tills du spricker"],
        "ERIKSTORP": ["– dags att undersöka om bollarna faktiskt byggs här", "– för att testa baklängesgång genom byn", "– perfekt aerodynamik för drakflygning från fjället"],
        "BOLLEBYGD": ["– dags att undersöka om bollarna faktiskt byggs här", "– för att testa baklängesgång genom byn", "– perfekt aerodynamik för drakflygning från fjället"],
        "ERIKSTORP VIA BOLLEBYGD": ["– dags att undersöka om bollarna faktiskt byggs här", "– för att testa baklängesgång genom byn", "– perfekt aerodynamik för drakflygning från fjället", "– en noggrant uträknad omväg för vetenskapens skull"],
        "LÄNGHEM": ["– dags att spökjaga med värmekamera på Torpa", "– för att mäta exakt hur 'långt hem' det faktiskt är", "– testa hållfastheten i medeltida stenmurar", "– ett utmärkt tillfälle för ett djupdyk i Åsunden"],
        "KALMAR C": ["– för att bygga ett slott av kroppkakor", "– dags att leta efter den försvunna unionen", "– dags att testa brons aerodynamik i sidvind", "– undersök hur många Gustav Vasa-kopior som ryms på slottet"],
        "KALMAR": ["– för att bygga ett slott av kroppkakor", "– dags att leta efter den försvunna unionen", "– dags att testa brons aerodynamik i sidvind", "– undersök hur många Gustav Vasa-kopior som ryms på slottet"],
        "ALINGSÅS": ["– varning: extrem risk för överfika", "– dags att räkna exakt hur många potatisar som ryms i en säck", "– medtag egen medhavd finkaffekopp", "– där ljuset i tunneln är en årlig festival"],
        "DALSJÖFORS": ["– för att bada i Dalsjön tills du utvecklar gälar", "– dags att mäta vattenkvaliteten i Dalsjön", "– för att leta efter textiliernas försvunna guldålder"],
        "VRALEN": ["– dags att utforska skogarnas mystik", "– perfekt plats för en hemlig trädkoja", "– för att studera den lokala mossans tillväxt", "– glöm inte kompassen och fältbiolog-kepsen"],
        "VRÅLEN": ["– dags att utforska skogarnas mystik", "– perfekt plats för en hemlig trädkoja", "– för att studera den lokala mossans tillväxt", "– glöm inte kompassen och fältbiolog-kepsen"],
        "CENTRUM": ["– dags att uppleva stadens puls", "– varning för intensiv shopping", "– navigera försiktigt bland rondellerna"],
        "KNALLELAND": ["– dags att fynda loss bland butikerna", "– varning för överfulla shoppingkassar", "– för att inspektera Knalle-historien närmare"],
        "BORÅS_LOKAL": [
            "– glöm inte paraplyet, det är ju Borås!", "– dags att räkna hur många rondeller vi passerar",
            "– staden där regn är en accepterad livsstil", "– utmärkt väder för att testa nya gummistövlar",
            "– mot textiliernas förlovade land", "– kolla om Pinocchios näsa har vuxit idag",
            "– dags att mäta vattennivån i Viskan", "– staden med fler postorderpaket än invånare",
            "– drivs bussen av regnvatten? Undersök saken!", "– dags att uppfinna ett nytt aerodynamiskt regnplagg",
            "– håll utkik efter tyg-reor längs vägen", "– Sveriges blötaste, men helt klart bästa stad",
            "– perfekt klimat för att sitta inne och fika", "– navigera via bronsstatyer och rondellkonst",
            "– en
