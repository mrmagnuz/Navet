<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>NAVET | Live-tavla</title>
    <link href="https://fonts.googleapis.com/css2?family=Amatic+SC:wght@700&family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --navet-green: #49a441; --navet-dark: #1D1D1B; --vt-red: #E3000F; }
        body {
            font-family: 'Montserrat', sans-serif;
            background: #eee url('https://www.navet.com/wp-content/uploads/2023/03/bg3.png') no-repeat center center fixed;
            background-size: cover; margin: 0; padding: 0; height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
        }
        header {
            padding: 15px 40px; display: flex; justify-content: space-between; align-items: center;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px);
            border-bottom: 3px solid var(--navet-green); z-index: 1000; flex-shrink: 0;
        }
        .logo-img { height: 50px; }
        .header-title { font-size: 1.6rem; font-weight: 900; text-transform: uppercase; }
        #clock { font-size: 2.5rem; font-weight: 900; }
        
        .main-content {
            display: flex; flex-grow: 1; padding: 15px 20px; gap: 20px; overflow: hidden;
        }
        .left-panel {
            flex: 2; display: flex; flex-direction: column; gap: 15px; min-width: 0;
        }
        .simonsland-cols {
            display: flex; gap: 20px; flex-shrink: 0;
        }
        .right-panel {
            flex: 1; display: flex; flex-direction: column; min-width: 0;
        }
        
        .column { flex: 1; display: flex; flex-direction: column; }
        .full-height-col { height: 100%; }
        
        .column-header {
            font-family: 'Amatic SC', cursive; font-size: 1.8rem; text-align: center;
            background: var(--navet-dark); color: white; padding: 5px; border-radius: 8px 8px 0 0; margin-bottom: 5px; flex-shrink: 0;
        }
        
        .map-wrapper {
            display: flex; flex-direction: column; flex-grow: 1;
        }
        .map-header {
            font-family: 'Amatic SC', cursive; font-size: 1.8rem; text-align: center;
            background: var(--navet-dark); color: white; padding: 5px; border-radius: 8px 8px 0 0; margin-bottom: 0; flex-shrink: 0;
        }
        #map { 
            flex-grow: 1; border-radius: 0 0 8px 8px; border: 3px solid var(--navet-dark); border-top: none; z-index: 1; background: #e5e3df;
        }

        .departure-list { display: flex; flex-direction: column; gap: 4px; overflow: hidden; }
        .departure-row {
            background: rgba(255, 255, 255, 0.95); display: flex; align-items: center; padding: 8px 12px;
            border-radius: 8px; border-right: 6px solid var(--navet-green);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); min-height: 60px;
        }
        .line-badge { 
            min-width: 45px; height: 45px; display: flex; justify-content: center; align-items: center;
            font-weight: 900; border-radius: 6px; margin-right: 12px; color: white; font-size: 1.1rem; flex-shrink: 0;
        }
        
        .dest-wrapper { flex-grow: 1; overflow: hidden; display: flex; flex-direction: column; justify-content: center; }
        .destination { font-size: 0.95rem; font-weight: 900; text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; }
        
        .sub-info {
            display: flex;
            align-items: center;
            gap: 8px; 
            overflow: hidden;
        }
        
        .platform { 
            font-size: 0.75rem; 
            color: #666; 
            font-weight: 700; 
            text-transform: uppercase; 
            flex-shrink: 0; 
        }

        .easter-egg { 
            color: #3b8734; 
            font-size: 0.8rem; 
            font-style: italic; 
            font-weight: 700; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            flex-grow: 1;
        }
        
        .time-area { text-align: right; min-width: 60px; flex-shrink: 0; }
        .eta { font-size: 1.5rem; font-weight: 900; color: var(--navet-green); line-height: 1; }
        
        /* FOOTER MED RULLANDE TEXT */
        footer { 
            padding: 8px 40px; background: var(--navet-dark); color: white; display: flex; 
            justify-content: space-between; align-items: center; font-weight: 700; font-size: 0.9rem; flex-shrink: 0; 
            height: 35px;
        }
        .footer-left { white-space: nowrap; flex-shrink: 0; }
        .footer-right { display: flex; gap: 15px; align-items: center; white-space: nowrap; flex-shrink: 0; }
        
        /* Den nya mitten-sektionen med mask-image f√∂r snygg uttoning i kanterna */
        .footer-center {
            flex-grow: 1;
            overflow: hidden;
            margin: 0 30px;
            display: flex;
            align-items: center;
            height: 100%;
            mask-image: linear-gradient(to right, transparent, black 2%, black 98%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 2%, black 98%, transparent);
        }

        .marquee-container {
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
        }

        .marquee-content {
            display: inline-block;
            padding-left: 100%;
            animation: marquee 25s linear infinite;
            color: var(--navet-green);
            font-weight: 900;
            letter-spacing: 0.5px;
            font-size: 1rem;
        }

        @keyframes marquee {
            0%   { transform: translate(0, 0); }
            100% { transform: translate(-100%, 0); }
        }

        #countdown-timer { color: var(--navet-green); font-weight: 900; }
        #debug-log { font-size: 0.75rem; opacity: 0.7; color: #ffcc00; }
    </style>
</head>
<body>

<header>
    <img src="https://fssc.se/wp-content/uploads/2023/09/Logotyp-svart-768x290.png" class="logo-img">
    <div class="header-title">H√•llplatser Simonsland & Resecentrum</div>
    <div id="clock">00:00</div>
</header>

<div class="main-content">
    <div class="left-panel">
        <div class="simonsland-cols">
            <div class="column">
                <div class="column-header">Simonsland (L√§ge A)</div>
                <div id="board-simonsland-in" class="departure-list">Laddar...</div>
            </div>
            <div class="column">
                <div class="column-header">Simonsland (L√§ge B)</div>
                <div id="board-simonsland-out" class="departure-list">Laddar...</div>
            </div>
        </div>
        
        <div class="map-wrapper">
            <div class="map-header">H√§r ser du livepositionen p√• Ettans bussar</div>
            <div id="map"></div>
        </div>
    </div>
    
    <div class="right-panel">
        <div class="column full-height-col">
            <div class="column-header">Resecentrum (T√•g & Region)</div>
            <div id="board-resecentrum" class="departure-list">Laddar...</div>
        </div>
    </div>
</div>

<footer>
    <div class="footer-left">UPPLEV. L√ÑR. UTFORSKA.</div>
    
    <div class="footer-center">
        <div class="marquee-container">
            <div class="marquee-content" id="fact-marquee">Laddar dagens fakta...</div>
        </div>
    </div>

    <div class="footer-right">
        <span id="countdown-timer">Uppdaterar om: 30s</span>
        <span style="opacity: 0.3;">|</span>
        <span id="debug-log">System startar...</span>
    </div>
</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const V_KEY = 'QlypIiMS1PaWXe5Nu1HWl1bCYU8a';
    const V_SECRET = 'OfZF4rSB2MaWEx1qgTtuMVMue70a';
    const TV_KEY = '8b529134e7844ac48320577d18d0237e';

    function setDebug(msg) { document.getElementById('debug-log').innerText = msg; }

    let timeToUpdate = 30;
    let map, vehicleLayer;
    let accessToken = "";
    
    let usedEasterEggs = new Set();

    const NAVET_ENTRE = [57.724285, 12.936959];
    const STOP_SIMONSLAND = [57.72557, 12.93841];
    const STOP_RESECENTRUM = [57.720733, 12.932754];

    // --- 50 ROLIGA FAKTA F√ñR RULLTEXTEN ---
    const funFacts = [
        "Vattenmolekyler √§r pyttesm√• ‚Äì en enda vattendroppe inneh√•ller fler molekyler √§n det finns droppar i havet!",
        "Du delar cirka 50 % av ditt DNA med en banan.",
        "Ljusets hastighet √§r ungef√§r 300 000 kilometer i sekunden.",
        "Det tar drygt √•tta minuter f√∂r ljuset fr√•n solen att resa hela v√§gen till jorden.",
        "En blixt kan v√§rma upp luften runt omkring till 30 000 grader ‚Äì fem g√•nger varmare √§n solens yta!",
        "Navet slog upp portarna f√∂r f√∂rsta g√•ngen redan 1989. Vi har √§lskat naturvetenskap i √∂ver 30 √•r!",
        "Bl√§ckfiskar har tre hj√§rtan och deras blod √§r bl√•tt.",
        "Det finns fler stj√§rnor i universum √§n det finns sandkorn p√• alla jordens str√§nder tillsammans.",
        "Om du vecklade ut alla blodk√§rl i din kropp skulle de r√§cka √∂ver tv√• varv runt jorden.",
        "Ett normalstort moln v√§ger ungef√§r lika mycket som 100 elefanter!",
        "Arkeologer har hittat 3000 √•r gammal honung i egyptiska gravar ‚Äì och den g√•r fortfarande att √§ta!",
        "Hela 70 % av jordens syre produceras av alger och v√§xtplankton i havet, inte av tr√§d.",
        "Ett fullvuxet tr√§d kan suga √•t sig upp till 20 kilo koldioxid p√• ett √•r.",
        "Ljud f√§rdas mer √§n fyra g√•nger snabbare i vatten √§n vad det g√∂r i luft.",
        "Myror sover aldrig p√• riktigt. De tar ist√§llet pyttesm√• tupplurar p√• cirka 8 minuter, tv√• g√•nger om dagen.",
        "Vatten expanderar med n√§stan 10 % n√§r det fryser. Det √§r d√§rf√∂r isbitar flyter i glaset!",
        "Guld √§r extremt formbart. Ett enda gram guld kan dras ut till en √∂ver 3 kilometer l√•ng tr√•d.",
        "Du blinkar ungef√§r 15‚Äì20 g√•nger i minuten. Det blir mer √§n 10 miljoner blinkningar p√• ett √•r!",
        "Astronauter kan bli upp till fem centimeter l√§ngre i rymden eftersom ryggraden t√§njs ut utan gravitation.",
        "Jordens inre k√§rna √§r lika varm som solens yta, ungef√§r 6000 grader Celsius.",
        "Ett struts√∂ga √§r faktiskt st√∂rre √§n dess hj√§rna.",
        "Diamanter √§r h√•rda, men de kan faktiskt brinna om temperaturen √∂verstiger 700 grader i rent syre.",
        "Det kr√§vs ungef√§r 2700 liter vatten f√∂r att producera en enda t-shirt av bomull. H√•llbart √§r smart!",
        "Eiffeltornet i Paris kan bli upp till 15 centimeter h√∂gre p√• sommaren n√§r v√§rmen f√•r metallen att utvidgas.",
        "Visste du att det finns en fj√§ril som smakar med f√∂tterna? S√• hittar den r√§tt blad att l√§gga √§gg p√•.",
        "Sn√∂flingor har alltid exakt sex kanter. Ren och sk√§r matematik direkt fr√•n himlen!",
        "Isbj√∂rnar ser vita ut, men under p√§lsen √§r deras hud helt svart f√∂r att b√§ttre absorbera v√§rme fr√•n solen.",
        "En loppa kan hoppa 200 g√•nger sin egen l√§ngd. Om du var en loppa hade du kunnat hoppa √∂ver ett h√∂ghus!",
        "M√§nniskokroppen inneh√•ller tillr√§ckligt med kol f√∂r att tillverka blyertset till 900 pennor.",
        "Forskare har uppt√§ckt en planet (55 Cancri e) som de tror till stor del best√•r av solid diamant.",
        "Det finns √∂ver 100 miljarder galaxer i det observerbara universumet.",
        "Hajar simmade runt i v√•ra hav l√•ngt innan de allra f√∂rsta tr√§den ens hade utvecklats p√• land.",
        "Kameleonter kan r√∂ra och fokusera sina √∂gon i tv√• helt olika riktningar samtidigt.",
        "Bananer inneh√•ller en minimal (och helt ofarlig) m√§ngd av en radioaktiv isotop, vilket g√∂r dem svagt radioaktiva.",
        "Det matematiska talet Pi (3,14...) har o√§ndligt m√•nga decimaler utan att n√•got m√∂nster n√•gonsin upprepas.",
        "Din n√§sa √§r ett superorgan ‚Äì den kan minnas upp till 50 000 olika dofter.",
        "Glas √§r ett fantastiskt material som kan sm√§ltas ner och √•tervinnas o√§ndligt m√•nga g√•nger utan att tappa kvalitet.",
        "Valar √§r, f√∂rutom m√§nniskan, det enda d√§ggdjuret som man vet sjunger melodiska s√•nger f√∂r varandra.",
        "DNA-kedjan i en enda av dina celler √§r ungef√§r tv√• meter l√•ng om du skulle str√§cka ut den.",
        "Ett √§pple flyter i vatten eftersom hela 25 % av √§pplets volym faktiskt best√•r av ren luft.",
        "Bor√•s √§r k√§nt f√∂r regn, men regn √§r ju egentligen bara vattnets fascinerande kretslopp i action!",
        "En vuxen m√§nniska best√•r till cirka 60 % av vatten. Inte konstigt att vi trivs i Bor√•s!",
        "Spindlar har faktiskt inte r√∂tt blod som vi, deras blod √§r helt genomskinligt.",
        "Visste du att Vintergatan r√∂r sig mot Andromedagalaxen? Om cirka 4 miljarder √•r kommer de att krocka.",
        "Det matematiska Fibonacci-m√∂nstret styr hur allt fr√•n solrosfr√∂n till tallkottar och ananas v√§xer.",
        "Om du drar ut dina tarmar i en l√•ng rad... s√• d√∂r du. (Men de √§r √∂ver 7 meter l√•nga!)",
        "Jorden snurrar runt sin egen axel i en hastighet av ungef√§r 1670 km/h vid ekvatorn.",
        "M√•nen r√∂r sig bort fr√•n jorden med ungef√§r 3,8 centimeter varje √•r.",
        "Vulkanen Olympus Mons p√• Mars √§r solsystemets h√∂gsta berg, n√§stan tre g√•nger s√• h√∂gt som Mount Everest.",
        "Navet i cykelhjulet h√•ller allt samman. Tillsammans upplever, l√§r och utforskar vi v√§rlden!"
    ];

    let currentFactIndex = Math.floor(Math.random() * funFacts.length);

    window.onload = function() {
        if (typeof L === 'undefined') {
            setDebug("V√§ntar p√• internetanslutning... Laddar om sidan om 5 sek.");
            setTimeout(() => location.reload(), 5000);
            return;
        }
        
        // Initiera den rullande texten
        const marqueeEl = document.getElementById("fact-marquee");
        marqueeEl.innerText = "üí° VISSTE DU ATT: " + funFacts[currentFactIndex];
        
        // Byt fakta varje g√•ng animationen b√∂rjar om!
        marqueeEl.addEventListener("animationiteration", () => {
            currentFactIndex = (currentFactIndex + 1) % funFacts.length;
            marqueeEl.innerText = "üí° VISSTE DU ATT: " + funFacts[currentFactIndex];
        });

        initSystem();
    };

    function centerMap() {
        if(map) {
            map.invalidateSize();
            map.setView(NAVET_ENTRE, 14.5);
        }
    }

    function initSystem() {
        updateClock();
        setInterval(updateClock, 1000);
        setInterval(() => {
            timeToUpdate--;
            if (timeToUpdate < 0) timeToUpdate = 30;
            document.getElementById('countdown-timer').innerText = `Uppdaterar om: ${timeToUpdate}s`;
        }, 1000);

        map = L.map('map', { zoomControl: false }).setView(NAVET_ENTRE, 14.5);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

        L.polyline([NAVET_ENTRE, [57.7245, 12.9378], [57.7250, 12.9382], STOP_SIMONSLAND], {color: '#1D1D1B', weight: 4, dashArray: '5, 8', opacity: 0.6}).addTo(map);
        L.polyline([NAVET_ENTRE, [57.723437,12.936337], [57.723231,12.936766], [57.722543,12.935414], [57.722016,12.935114], [57.722051,12.934771], [57.72185,12.934277], [57.721134,12.933049], [57.720933,12.932829], STOP_RESECENTRUM], {color: '#1D1D1B', weight: 4, dashArray: '5, 8', opacity: 0.6}).addTo(map);

        L.circleMarker(NAVET_ENTRE, { radius: 8, fillColor: "#49a441", color: "#fff", weight: 3, fillOpacity: 1 }).addTo(map).bindTooltip("DU √ÑR H√ÑR", {permanent: true, direction: 'left'});
        L.circleMarker(STOP_SIMONSLAND, { radius: 6, fillColor: "#1D1D1B", color: "#fff", weight: 2, fillOpacity: 1 }).addTo(map).bindTooltip("Simonsland", {permanent: true, direction: 'left'});
        L.circleMarker(STOP_RESECENTRUM, { radius: 6, fillColor: "#1D1D1B", color: "#fff", weight: 2, fillOpacity: 1 }).addTo(map).bindTooltip("Resecentrum", {permanent: true, direction: 'left'});

        vehicleLayer = L.layerGroup().addTo(map);

        setInterval(update, 30000); 
        update();
        
        setTimeout(centerMap, 500);
        setTimeout(centerMap, 1500);
    }

    function translateTouristDestinations(dest) {
        if (!dest) return "OK√ÑND";
        let dUpper = dest.toUpperCase();
        if ((dUpper.includes("H√ÑSSLEHOLMEN") || dUpper.includes("H√ÑSLLEHOLMEN")) && dUpper.includes("SJUKHUSET")) return "CENTRUM";
        if (dUpper.includes("SJ√ñBO")) return "KNALLELAND";
        return dest; 
    }

    const easterEggs = {
        "G√ñTEBORG": ["‚Äì f√∂r att leta efter Glenn", "‚Äì dags att ber√§kna vindmotst√•ndet p√• Avenyn", "‚Äì medtag egen paraply-krockkudde"],
        "G√ñTEBORG C": ["‚Äì f√∂r att leta efter Glenn", "‚Äì dags att ber√§kna vindmotst√•ndet p√• Avenyn", "‚Äì medtag egen paraply-krockkudde"],
        "UDDEVALLA": ["‚Äì f√∂r att bygga en ub√•t av sn√§ckskal", "‚Äì dags att utmana en fiskm√•s i schack"],
        "VISKAFORS": ["‚Äì f√∂r att spana efter Viskan-odjuret", "‚Äì dags att m√§ta friktionen i gummisulor"],
        "KINNARUMMA": ["‚Äì orten med det roligaste namnet att s√§ga snabbt", "‚Äì dags att r√§kna antalet epatraktorer"],
        "KINNA": ["‚Äì f√∂r att rulla in dig i 14 meter tyg", "‚Äì dags att sy en rymddr√§kt av gamla gardiner", "‚Äì varning: extrem risk f√∂r tr√•dtrazzel"],
        "SKENE": ["‚Äì f√∂r att rulla in dig i 14 meter tyg", "‚Äì dags att sy en rymddr√§kt av gamla gardiner"],
        "SVENLJUNGA": ["‚Äì f√∂r att koka kaffe p√• √Ñtran-vatten", "‚Äì dags att uppfinna en ny typ av papperskorg"],
        "FRISTAD": ["‚Äì dags att bygga ett fort av kl√§dh√§ngare", "‚Äì f√∂r att m√§ta ljudets hastighet √∂ver sj√∂n"],
        "TRANEMO": ["‚Äì f√∂r att testa h√•llfastheten i glasrutor", "‚Äì orten d√§r sexkanten √§r den heligaste formen"],
        "ULRICEHAMN": ["‚Äì f√∂r att √•ka l√§ngdskidor p√• asfalten", "‚Äì unders√∂k friktionen mellan byxa och pulkabacke"],
        "ULRICEHAMN VIA G√ÑLLSTAD": ["‚Äì f√∂r att √•ka l√§ngdskidor p√• asfalten", "‚Äì unders√∂k friktionen mellan byxa och pulkabacke"],
        "SANDARED": ["‚Äì f√∂r att ber√§kna sandkornens totala densitet", "‚Äì dags att bygga sandslott i stormvind"],
        "HERRLJUNGA": ["‚Äì dags att provsmaka 40 liter √§ppelcider", "‚Äì analysera ciderns koldioxidbubblor i mikroskop", "‚Äì t√•get mot t√•gbytenas urmoder!"],
        "VARBERG": ["‚Äì f√∂r att m√§ta havets salthalt med tungan", "‚Äì perfekt f√∂r en f√§ltstudie i m√•sars st√∂rtflygning", "‚Äì dags att leta efter f√§stningen i m√∂rkret!"],
        "√ñXNERED": ["‚Äì 'Lilla Paris' beh√∂ver fler baguetter", "‚Äì dags att m√§ta vattenst√•ndet med tumstock"],
        "V√ÑNERSBORG": ["‚Äì 'Lilla Paris' beh√∂ver fler baguetter", "‚Äì dags att m√§ta vattenst√•ndet med tumstock"],
        "HORRED": ["‚Äì dags att v√§va en matta av hall√§ndskt gr√§s", "‚Äì varning f√∂r pl√∂tsliga skurar av garn"],
        "VEDDIGE": ["‚Äì f√∂r att spela ishockey p√• gr√§s", "‚Äì dags att unders√∂ka kornas matsm√§ltning"],
        "SVANEHOLM": ["‚Äì f√∂r att infiltrera svanarnas hemliga bas", "‚Äì medtag egen fj√§derboa f√∂r kamouflage"],
        "G√ÑLLSTAD": ["‚Äì f√∂r att testa elasticiteten i 100 par byxor", "‚Äì trik√•-paradiset kallar!"],
        "ERIKSTORP": ["‚Äì dags att unders√∂ka om bollarna faktiskt byggs h√§r", "‚Äì f√∂r att testa bakl√§ngesg√•ng genom byn"],
        "BOLLEBYGD": ["‚Äì dags att unders√∂ka om bollarna faktiskt byggs h√§r", "‚Äì f√∂r att testa bakl√§ngesg√•ng genom byn"],
        "ERIKSTORP VIA BOLLEBYGD": ["‚Äì en noggrant utr√§knad omv√§g f√∂r vetenskapens skull", "‚Äì f√∂r att testa bakl√§ngesg√•ng genom byn"],
        "L√ÑNGHEM": ["‚Äì dags att sp√∂kjaga med v√§rmekamera p√• Torpa", "‚Äì f√∂r att m√§ta exakt hur 'l√•ngt hem' det faktiskt √§r"],
        "KALMAR C": ["‚Äì f√∂r att bygga ett slott av kroppkakor", "‚Äì dags att leta efter den f√∂rsvunna unionen"],
        "KALMAR": ["‚Äì f√∂r att bygga ett slott av kroppkakor", "‚Äì dags att leta efter den f√∂rsvunna unionen"],
        "ALINGS√ÖS": ["‚Äì varning: extrem risk f√∂r √∂verfika", "‚Äì medtag egen medhavd finkaffekopp"],
        "DALSJ√ñFORS": ["‚Äì f√∂r att bada i Dalsj√∂n tills du utvecklar g√§lar", "‚Äì dags att m√§ta vattenkvaliteten i Dalsj√∂n"],
        "VRALEN": ["‚Äì perfekt plats f√∂r en hemlig tr√§dkoja", "‚Äì gl√∂m inte kompassen och f√§ltbiolog-kepsen"],
        "VR√ÖLEN": ["‚Äì perfekt plats f√∂r en hemlig tr√§dkoja", "‚Äì gl√∂m inte kompassen och f√§ltbiolog-kepsen"],
        "CENTRUM": [
            "‚Äì dags att uppleva stadens puls", 
            "‚Äì navigera f√∂rsiktigt bland rondellerna",
            "‚Äì biopopcornen v√§ntar runt h√∂rnet!",
            "‚Äì perfekt l√§ge f√∂r en god restaurangmiddag",
            "‚Äì dags f√∂r en natt p√• hotell, kanske?",
            "‚Äì ta en mysig promenad genom Stadsparken",
            "‚Äì gl√∂m inte badbyxorna, Stadsparksbadet kallar!",
            "‚Äì dags f√∂r lite f√∂nstershopping p√• stan",
            "‚Äì mot Bor√•s bultande hj√§rta!",
            "‚Äì en fika p√• stan sitter aldrig fel"
        ],
        "KNALLELAND": [
            "‚Äì dags att fynda loss bland butikerna", 
            "‚Äì f√∂r att inspektera Knalle-historien n√§rmare",
            "‚Äì fram√•t Di Gule! Mot Bor√•s Arena!",
            "‚Äì dags att insupa doften av konstgr√§s och tre po√§ng",
            "‚Äì gl√∂m inte den gulsvarta halsduken!",
            "‚Äì f√∂r att leta efter gamla friidrottsrekord p√• Ryavallen",
            "‚Äì historiska vingslag fr√•n klassiska Ryavallen v√§ntar",
            "‚Äì ska du shoppa eller heja fram IF Elfsborg? Varf√∂r inte b√•da!"
        ],
        "BOR√ÖS_LOKAL": [
            "‚Äì gl√∂m inte paraplyet, det √§r ju Bor√•s!", 
            "‚Äì dags att r√§kna hur m√•nga rondeller vi passerar",
            "‚Äì staden d√§r regn √§r en accepterad livsstil", 
            "‚Äì utm√§rkt v√§der f√∂r att testa nya gummist√∂vlar",
            "‚Äì kolla om Pinocchios n√§sa har vuxit idag", 
            "‚Äì dags att m√§ta vattenniv√•n i Viskan",
            "‚Äì staden med fler postorderpaket √§n inv√•nare", 
            "‚Äì drivs bussen av regnvatten? Unders√∂k saken!",
            "‚Äì dags att uppfinna ett nytt aerodynamiskt regnplagg", 
            "‚Äì h√•ll utkik efter tyg-reor l√§ngs v√§gen",
            "‚Äì Sveriges bl√∂taste, men helt klart b√§sta stad", 
            "‚Äì perfekt klimat f√∂r att sitta inne och fika",
            "‚Äì en expedition genom bomull, regn och polyester", 
            "‚Äì dags att spana efter f√∂rrymda apor fr√•n djurparken",
            "‚Äì n√§sta stopp: en nio meter h√∂g bronsskulptur",
            "‚Äì visste du att Bor√•s har flest gatum√•lningar per capita?",
            "‚Äì staden d√§r fredagsmyset levereras med postorder",
            "‚Äì k√§nn doften av nytryckt Ellos-katalog!",
            "‚Äì dags att fika under ett gigantiskt tygstycke",
            "‚Äì vi k√∂r tills vi hittar solen (kan ta tid)",
            "‚Äì Bor√•s: D√§r regndroppar ofta faller horisontellt",
            "‚Äì √§r det 100% bomull i buss-s√§tena?",
            "‚Äì dags att titta p√• skulpturer och bli lite finkulturell",
            "‚Äì medtag egen flytv√§st f√∂r s√§kerhets skull",
            "‚Äì navet i svensk teko-industri (och regnproduktion)",
            "‚Äì staden som √§r vackrast i 50 nyanser av gr√•tt"
        ]
    };

    function getEasterEgg(destination, isLocalBus, uniqueId) {
        if (!destination) return "";
        const destUpper = destination.toUpperCase();
        
        let pool = [];
        if (easterEggs[destUpper]) {
            pool = easterEggs[destUpper];
        } else if (isLocalBus && easterEggs["BOR√ÖS_LOKAL"]) {
            pool = easterEggs["BOR√ÖS_LOKAL"];
        }

        if (pool.length === 0) return "";
        
        let hash = 0;
        const str = uniqueId ? uniqueId.toString() : destination;
        for (let i = 0; i < str.length; i++) {
            hash = str.charCodeAt(i) + ((hash << 5) - hash);
        }
        hash = Math.abs(hash);

        let startIndex = hash % pool.length;
        let selectedText = pool[startIndex];

        let attempts = 0;
        while (usedEasterEggs.has(selectedText) && attempts < pool.length) {
            startIndex = (startIndex + 1) % pool.length;
            selectedText = pool[startIndex];
            attempts++;
        }

        usedEasterEggs.add(selectedText);

        return `<span class="easter-egg">${selectedText}</span>`;
    }

    async function getToken() {
        try {
            setDebug("Ansluter till V√§sttrafik...");
            const res = await fetch('https://ext-api.vasttrafik.se/token', {
                method: 'POST',
                headers: { 
                    'Authorization': 'Basic ' + btoa(V_KEY + ':' + V_SECRET), 
                    'Content-Type': 'application/x-www-form-urlencoded' 
                },
                body: 'grant_type=client_credentials'
            });
            if (!res.ok) throw new Error("V√§sttrafik API Fel (" + res.status + ")");
            const data = await res.json();
            accessToken = data.access_token;
            setDebug("Uppdaterar tavlor...");
        } catch (e) { 
            accessToken = ""; 
            throw e; 
        }
    }

    function showErrorOnBoards(msg) {
        const errorHtml = `<div style='padding:15px; color:var(--vt-red); font-weight:bold; background:rgba(255,255,255,0.9); border-radius:8px;'>N√§tverksfel. F√∂rs√∂ker ansluta igen...<br><span style='font-size:0.7em; color:#666;'>${msg}</span></div>`;
        document.getElementById('board-simonsland-in').innerHTML = errorHtml;
        document.getElementById('board-simonsland-out').innerHTML = errorHtml;
        document.getElementById('board-resecentrum').innerHTML = errorHtml;
        setDebug("V√§ntar p√• n√§tverk...");
    }

    async function update() {
        try {
            timeToUpdate = 30;
            usedEasterEggs.clear();

            if (!accessToken) await getToken();
            if (!accessToken) return;

            let tvStatusMsg = "S√∂ker TV...";
            let tvT√•gAntal = 0;

            // --- 1. H√ÑMTA SIMONSLAND ---
            const urlS = `https://ext-api.vasttrafik.se/pr/v4/stop-areas/9021014082035000/departures?limit=100&timeSpan=1440&maxDeparturesPerLineAndDirection=4`;
            const resS = await fetch(urlS, { headers: { 'Authorization': 'Bearer ' + accessToken } });
            
            if (resS.status === 401) { accessToken = ""; throw new Error("Nyckel utg√•ngen"); }
            
            if (resS.ok) {
                const dataS = await resS.json();
                const renderBoard = (platform, elId, forceColor) => {
                    let html = "", count = 0;
                    if (dataS.results) {
                        for (let dep of dataS.results) {
                            const isA = dep.stopPoint && dep.stopPoint.platform === "A";
                            const match = platform === "A" ? isA : !isA;
                            if (match && count < 4) {
                                html += createRow(dep, false, false, forceColor); 
                                count++;
                            }
                        }
                    }
                    document.getElementById(elId).innerHTML = html || "<div style='padding:10px;'>Inga avg√•ngar funna.</div>";
                };
                
                renderBoard("A", "board-simonsland-in", "var(--vt-red)");
                renderBoard("B", "board-simonsland-out", "var(--navet-green)");
            }

            // --- 2. RESECENTRUM (T√•g & Region) ---
            let combined = [];

            // A. T√•g fr√•n Trafikverket
            try {
                const tvXML = `<REQUEST>
                    <LOGIN authenticationkey="${TV_KEY}" />
                    <QUERY objecttype="TrainAnnouncement" schemaversion="1.9" orderby="AdvertisedTimeAtLocation" limit="50">
                        <FILTER>
                            <AND>
                                <EQ name="LocationSignature" value="Bsc" />
                                <EQ name="ActivityType" value="Avgang" />
                                <GT name="AdvertisedTimeAtLocation" value="$dateadd(-0.00:15:00)" />
                                <LT name="AdvertisedTimeAtLocation" value="$dateadd(0.12:00:00)" />
                            </AND>
                        </FILTER>
                        <INCLUDE>InformationOwner</INCLUDE>
                        <INCLUDE>AdvertisedTimeAtLocation</INCLUDE>
                        <INCLUDE>EstimatedTimeAtLocation</INCLUDE>
                        <INCLUDE>TrackAtLocation</INCLUDE>
                        <INCLUDE>ToLocation</INCLUDE>
                        <INCLUDE>ProductInformation</INCLUDE>
                        <INCLUDE>Canceled</INCLUDE>
                        <INCLUDE>AdvertisedTrainIdent</INCLUDE>
                    </QUERY>
                </REQUEST>`;
                
                const resT = await fetch("https://api.trafikinfo.trafikverket.se/v2/data.json", {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: tvXML
                });
                
                if (resT.ok) {
                    const dataT = await resT.json();

                    if (dataT.RESPONSE && dataT.RESPONSE.RESULT[0].TrainAnnouncement) {
                        const trains = dataT.RESPONSE.RESULT[0].TrainAnnouncement;
                        tvT√•gAntal = trains.length;
                        tvStatusMsg = `TV-T√•g h√§mtade: ${tvT√•gAntal} st.`;
                        
                        trains.forEach(t => {
                            try {
                                if (t.Canceled === true) return; 
                                const rowHtml = createTrainRow(t);
                                if(rowHtml) {
                                    const trainTime = new Date(t.EstimatedTimeAtLocation || t.AdvertisedTimeAtLocation);
                                    combined.push({ t: trainTime, html: rowHtml, isTrain: true });
                                }
                            } catch (e) {}
                        });
                    } else if (dataT.RESPONSE && dataT.RESPONSE.RESULT[0].ERROR) {
                        tvStatusMsg = `TV Error: ${dataT.RESPONSE.RESULT[0].ERROR.MESSAGE}`;
                    } else {
                        tvStatusMsg = "TV Svarade: Inga t√•g funna f√∂r Bsc.";
                    }
                } else {
                    tvStatusMsg = `TV HTTP Fel: ${resT.status}`;
                }
            } catch (e) { 
                tvStatusMsg = "TV N√§tverksfel."; 
            }

            // C. Regionbussar fr√•n Resecentrum
            try {
                const urlB = `https://ext-api.vasttrafik.se/pr/v4/stop-areas/9021014082017000/departures?limit=60&timeSpan=1440&maxDeparturesPerLineAndDirection=5`;
                const resB = await fetch(urlB, { headers: { 'Authorization': 'Bearer ' + accessToken } });
                if (resB.ok) {
                    const dataB = await resB.json();
                    if (dataB.results) {
                        dataB.results.forEach(d => {
                            if (d.serviceJourney && d.serviceJourney.line) {
                                const lineNo = parseInt(d.serviceJourney.line.shortName);
                                const mode = (d.serviceJourney.line.transportMode || "").toLowerCase();
                                const lineName = d.serviceJourney.line.name ? d.serviceJourney.line.name.toLowerCase() : "";
                                const plat = d.stopPoint && d.stopPoint.platform ? d.stopPoint.platform : "";
                                
                                let isVtTrain = (mode === 'train' || mode === 'rail' || lineName.includes('t√•g') || ['1', '2', '3', '4'].includes(plat));

                                if (isVtTrain && tvT√•gAntal === 0) {
                                    const rowHtml = createRow(d, true, true, null); 
                                    if(rowHtml) combined.push({ t: new Date(d.estimatedTime || d.plannedTime), html: rowHtml, isTrain: true });
                                } else if (lineNo > 31 || isNaN(lineNo)) {
                                    const rowHtml = createRow(d, false, true, null); 
                                    if(rowHtml) combined.push({ t: new Date(d.estimatedTime || d.plannedTime), html: rowHtml, isTrain: false });
                                }
                            }
                        });
                    }
                }
            } catch(e) {}

            // -- FILTER OCH PRIORITERING (Endast strikt tid) --
            let uniqueCombined = [];
            let prevId = "";
            combined.sort((a,b) => a.t - b.t); 
            
            combined.forEach(item => {
                let id = item.t.getTime().toString() + item.html.substring(0,20);
                if (id !== prevId) {
                    uniqueCombined.push(item);
                    prevId = id;
                }
            });

            const limitTime = new Date(new Date().getTime() - 60000); 
            let futureItems = uniqueCombined.filter(item => item.t > limitTime);
            
            let finalItems = futureItems.slice(0, 12);

            let rHtml = "";
            finalItems.forEach(item => { rHtml += item.html; });

            document.getElementById('board-resecentrum').innerHTML = rHtml || "<div style='padding:10px;'>Inga avg√•ngar funna.</div>";
            
            setDebug(`Status: ${tvStatusMsg}`);

            setTimeout(centerMap, 200);

            // --- 3. KARTAN ---
            try {
                const urlP = `https://ext-api.vasttrafik.se/pr/v4/positions?lowerLeftLat=57.71&lowerLeftLong=12.91&upperRightLat=57.74&upperRightLong=12.96`;
                const resP = await fetch(urlP, { headers: { 'Authorization': 'Bearer ' + accessToken } });
                if (resP.ok) {
                    const pData = await resP.json();
                    vehicleLayer.clearLayers();
                    const busSvg = `<svg width="18" height="18" viewBox="0 0 24 24" fill="white"><path d="M4 16c0 .88.39 1.67 1 2.22v1.28c0 .83.67 1.5 1.5 1.5S8 20.33 8 19.5V19h8v.5c0 .82.67 1.5 1.5 1.5.82 0 1.5-.67 1.5-1.5v-1.28c.61-.55 1-1.34 1-2.22V6c0-3.5-3.58-4-8-4s-8 .5-8 4v10zm3.5 1c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17zm9 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm-1.5-6H6V6h12v5z"/></svg>`;

                    pData.forEach(v => {
                        if (v.latitude && v.line) {
                            let label = v.line.shortName || v.line.designation || v.line.name || "?";
                            if (label === "1") {
                                let dotColor = "var(--vt-red)";
                                if (v.direction && (v.direction.toUpperCase().includes("SJ√ñBO") || v.direction.toUpperCase().includes("KNALLELAND"))) {
                                    dotColor = "var(--navet-green)";
                                }
                                L.marker([v.latitude, v.longitude], {
                                    icon: L.divIcon({ 
                                        className: '', 
                                        iconSize: [30, 30],
                                        iconAnchor: [15, 15], 
                                        html: `<div style="background:${dotColor}; width:100%; height:100%; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow: 0 2px 4px rgba(0,0,0,0.4); border:2px solid white;">${busSvg}</div>` 
                                    })
                                }).addTo(vehicleLayer);
                            }
                        }
                    });
                }
            } catch(e) {}

        } catch (error) {
            showErrorOnBoards(error.message);
        }
    }

    function createRow(d, isTrainStyle, isRightColumn, customBadgeColor) {
        try {
            const time = new Date(d.estimatedTime || d.plannedTime);
            const diff = Math.round((time - new Date()) / 60000);
            let name = d.serviceJourney.line.shortName || d.serviceJourney.line.designation || "BUSS";
            let bg = d.serviceJourney.line.backgroundColor || "#333";
            
            let rawDest = d.serviceJourney.direction ? d.serviceJourney.direction.split(',')[0].trim() : "OK√ÑND";
            let dest = translateTouristDestinations(rawDest);
            const plat = d.stopPoint && d.stopPoint.platform ? d.stopPoint.platform : "-";
            
            const uniqueId = (d.serviceJourney && d.serviceJourney.id) ? d.serviceJourney.id : (name + dest + time.getTime());
            const egg = getEasterEgg(dest, !isRightColumn, uniqueId);
            
            if (isTrainStyle) {
                return `<div class="departure-row" style="border-right-color:#666666">
                    <div class="line-badge" style="background:#666666; font-size:0.7rem; text-align:center; padding: 2px; line-height:1.1;">V√ÑSTT√ÖG</div>
                    <div class="dest-wrapper">
                        <div class="destination">MOT ${dest}</div>
                        <div class="sub-info">
                            <span class="platform">Sp√•r ${plat}</span>
                            ${egg}
                        </div>
                    </div>
                    <div class="time-area"><span class="eta">${diff <= 0 ? 'NU' : diff}</span>${diff > 0 ? '<span style="font-size:0.6rem;display:block;font-weight:700">MIN</span>' : ''}</div>
                </div>`;
            }

            if (isRightColumn) bg = "#000000"; 
            else if (customBadgeColor) bg = customBadgeColor;

            return `<div class="departure-row">
                <div class="line-badge" style="background:${bg}">${name}</div>
                <div class="dest-wrapper">
                    <div class="destination">MOT ${dest}</div>
                    <div class="sub-info">
                        <span class="platform">L√§ge ${plat}</span>
                        ${egg}
                    </div>
                </div>
                <div class="time-area"><span class="eta">${diff <= 0 ? 'NU' : diff}</span>${diff > 0 ? '<span style="font-size:0.6rem;display:block;font-weight:700">MIN</span>' : ''}</div>
            </div>`;
        } catch(err) { return ""; }
    }

    function createTrainRow(t) {
        const timeStr = t.EstimatedTimeAtLocation || t.AdvertisedTimeAtLocation;
        if (!timeStr) return "";
        
        const diff = Math.round((new Date(timeStr) - new Date()) / 60000);
        
        const stations = { 
            'G': 'G√ñTEBORG C', 
            'HR': 'HERRLJUNGA', 'HRC': 'HERRLJUNGA', 
            'VV': 'VARBERG', 'VBC': 'VARBERG', 
            'UV': 'UDDEVALLA', 
            'KAC': 'KALMAR C', 
            'V√ñ': 'V√ÑXJ√ñ', 
            'B√ÖS': 'BOR√ÖS C' 
        };
        
        let dest = "OK√ÑND";
        if (t.ToLocation && t.ToLocation.length > 0) {
            const locObj = t.ToLocation[0];
            const locCode = (typeof locObj === 'string') ? locObj : locObj.LocationName;
            if (locCode) dest = stations[locCode.toUpperCase()] || locCode;
        }
        
        const uniqueId = t.AdvertisedTrainIdent ? t.AdvertisedTrainIdent : (dest + timeStr);
        const egg = getEasterEgg(dest, false, uniqueId);
        
        let op = "T√ÖG";
        if (t.ProductInformation && t.ProductInformation.length > 0) {
            const prod = t.ProductInformation[0];
            op = (typeof prod === 'string') ? prod : (prod.Description || "T√ÖG");
        } else if (t.InformationOwner) {
            op = t.InformationOwner;
        }
        if(!op) op = "T√ÖG";
        
        const plat = t.TrackAtLocation || '-';
        
        return `<div class="departure-row" style="border-right-color:#666666">
            <div class="line-badge" style="background:#666666; font-size:0.7rem; text-align:center; padding: 2px; line-height:1.1;">${op.substring(0,10).toUpperCase()}</div>
            <div class="dest-wrapper">
                <div class="destination">MOT ${dest}</div>
                <div class="sub-info">
                    <span class="platform">Sp√•r ${plat}</span>
                    ${egg}
                </div>
            </div>
            <div class="time-area"><span class="eta">${diff <= 0 ? 'NU' : diff}</span>${diff > 0 ? '<span style="font-size:0.6rem;display:block;font-weight:700">MIN</span>' : ''}</div>
        </div>`;
    }

    function updateClock() { 
        const now = new Date();
        document.getElementById('clock').innerText = now.toLocaleTimeString('sv-SE', {hour:'2-digit', minute:'2-digit'}); 
        
        if (now.getHours() === 3 && now.getMinutes() === 0 && now.getSeconds() === 0) {
            setDebug("Nattlig omstart f√∂r att rensa minnet...");
            location.reload();
        }
    }
</script>
</body>
</html>
