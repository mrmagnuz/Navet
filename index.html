<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NAVET | Live-tavla</title>
    <link href="https://fonts.googleapis.com/css2?family=Amatic+SC:wght@700&family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --navet-green: #49a441; --navet-dark: #1D1D1B; --line1-red: #e2001a; }
        body { font-family: 'Montserrat', sans-serif; background: #eee url('https://www.navet.com/wp-content/uploads/2023/03/bg3.png') no-repeat center center fixed; background-size: cover; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        header { padding: 10px 40px; display: flex; justify-content: space-between; align-items: center; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); border-bottom: 3px solid var(--navet-green); z-index: 1000; flex-shrink: 0; }
        .logo-img { height: 45px; }
        #clock { font-size: 2.2rem; font-weight: 900; }
        
        .main-wrapper { display: flex; flex: 1; padding: 15px 25px; gap: 20px; overflow: hidden; }
        .left-content { flex: 2; display: flex; flex-direction: column; gap: 15px; align-items: center; }
        .simonsland-grid { display: flex; gap: 15px; width: 100%; flex-shrink: 0; }
        
        .map-container { flex: 1; display: flex; justify-content: center; align-items: center; width: 100%; min-height: 0; }
        #map { height: 100%; aspect-ratio: 1 / 1; border-radius: 20px; border: 4px solid var(--navet-dark); background: #f9f9f9; box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        
        .right-content { flex: 1.1; display: flex; flex-direction: column; }
        .column { display: flex; flex-direction: column; flex: 1; overflow: hidden; }
        .column-header { font-family: 'Amatic SC', cursive; font-size: 1.8rem; text-align: center; background: var(--navet-dark); color: white; padding: 6px; border-radius: 8px 8px 0 0; margin-bottom: 5px; }
        .departure-list { display: flex; flex-direction: column; gap: 5px; padding: 5px; overflow-y: auto; }
        
        .departure-row { background: rgba(255, 255, 255, 0.95); display: flex; align-items: center; padding: 8px 14px; border-radius: 10px; border-right: 6px solid var(--navet-green); box-shadow: 0 3px 6px rgba(0,0,0,0.08); min-height: 60px; }
        .line-badge { min-width: 48px; height: 48px; display: flex; justify-content: center; align-items: center; font-weight: 900; border-radius: 8px; margin-right: 15px; color: white; background: #333; font-size: 1.2rem; }
        .dest-wrapper { flex-grow: 1; overflow: hidden; }
        .destination { font-size: 0.9rem; font-weight: 800; text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .platform { font-size: 0.8rem; color: #666; font-weight: 700; }
        .eta { font-size: 1.6rem; font-weight: 900; color: var(--navet-green); line-height: 1; }
        
        footer { padding: 12px 40px; background: var(--navet-dark); color: white; display: flex; justify-content: space-between; align-items: center; font-weight: 700; font-size: 1rem; flex-shrink: 0; border-top: 3px solid var(--navet-green); }
        .live-status { color: var(--navet-green); text-transform: uppercase; font-size: 0.85rem; }

        .navet-pin { width: 30px; height: 30px; background: var(--navet-green); border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 2px solid white; box-shadow: -2px 2px 5px rgba(0,0,0,0.3); }
        .bus-marker { background: var(--line1-red); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 16px; border: 2px solid white; box-shadow: 0 3px 6px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

<header>
    <img src="https://fssc.se/wp-content/uploads/2023/09/Logotyp-svart-768x290.png" class="logo-img" alt="Navet">
    <div style="font-weight: 900; text-transform: uppercase;">Live-trafik: Simonsland & Resecentrum</div>
    <div id="clock">00:00</div>
</header>

<div class="main-wrapper">
    <div class="left-content">
        <div class="simonsland-grid">
            <div class="column"><div class="column-header">SIMONSLAND MOT CENTRUM</div><div id="board-simonsland-in" class="departure-list">Ansluter...</div></div>
            <div class="column"><div class="column-header">SIMONSLAND MOT KNALLELAND</div><div id="board-simonsland-out" class="departure-list">Ansluter...</div></div>
        </div>
        <div class="map-container"><div id="map"></div></div>
    </div>
    <div class="right-content">
        <div class="column"><div class="column-header">RESECENTRUM (TÅG & REGION)</div><div id="board-resecentrum" class="departure-list">Ansluter...</div></div>
    </div>
</div>

<footer>
    <div class="live-status">Live - Uppdateras om <span id="timer">30</span> sekunder</div>
    <div>UPPLEV. LÄR. UTFORSKA.</div>
    <div>NAVET</div>
</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const NAVET_COORD = [57.724306, 12.937000];
    const map = L.map('map', { zoomControl: false, dragging: false, scrollWheelZoom: false }).setView(NAVET_COORD, 15);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
    const vehicleLayer = L.layerGroup().addTo(map);

    new ResizeObserver(() => { map.invalidateSize(); map.setView(NAVET_COORD, 15, { animate: false }); }).observe(document.getElementById('map'));

    L.polyline([NAVET_COORD, [57.7248, 12.9375], [57.7253, 12.9381], [57.72557, 12.93841]], {color: '#333', weight: 3, dashArray: '5, 10', opacity: 0.5}).addTo(map);
    L.polyline([NAVET_COORD, [57.7235, 12.9365], [57.7215, 12.9335], [57.7207, 12.9327]], {color: '#333', weight: 3, dashArray: '5, 10', opacity: 0.5}).addTo(map);

    const navetIcon = L.divIcon({ className: '', html: '<div class="navet-pin"></div>', iconSize: [30, 30], iconAnchor: [15, 30] });
    L.marker(NAVET_COORD, {icon: navetIcon}).addTo(map).bindTooltip("NAVET", {permanent: true, direction: 'top', offset: [0, -32]});

    const stationMap = { 'G':'GÖTEBORG C', 'HR':'HERRLJUNGA', 'VV':'VARBERG', 'UV':'UDDEVALLA', 'Ö':'ÖXNERED', 'VÄ':'VÄNERSBORG', 'KIN':'KINNA', 'SKE':'SKENE', 'BA':'BORÅS C', 'BS':'BORÅS C' };
    const V_KEY = 'QlypIiMS1PaWXe5Nu1HWl1bCYU8a';
    const V_SECRET = 'OfZF4rSB2MaWEx1qgTtuMVMue70a';
    const TV_KEY = '8b529134e7844ac48320577d18d0237e';
    const PROXY = 'https://corsproxy.io/?';
    
    let accessToken = "";
    let nextUpdate = 30;

    // --- KLOCKA OCH TIMER ---
    function tick() {
        const now = new Date();
        document.getElementById('clock').innerText = now.toLocaleTimeString('sv-SE', {hour: '2-digit', minute: '2-digit'});
        
        nextUpdate--;
        if (nextUpdate < 0) nextUpdate = 30;
        document.getElementById('timer').innerText = nextUpdate;
    }
    setInterval(tick, 1000);

    async function login() {
        if(accessToken) return true;
        try {
            const auth = btoa(V_KEY.trim() + ":" + V_SECRET.trim());
            const res = await fetch(PROXY + encodeURIComponent("https://ext-api.vasttrafik.se/token"), {
                method: 'POST', headers: { 'Authorization': 'Basic ' + auth, 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'grant_type=client_credentials'
            });
            if (res.ok) { const d = await res.json(); accessToken = d.access_token; return true; }
        } catch (e) {} return false;
    }

    async function update() {
        if(!await login()) return;
        nextUpdate = 30; // Nollställ timern vid lyckad start

        // Bussar på karta (Linje 1)
        try {
            const res = await fetch(PROXY + encodeURIComponent('https://ext-api.vasttrafik.se/pr/v4/positions?lowerLeftLat=57.71&lowerLeftLong=12.90&upperRightLat=57.74&upperRightLong=12.96'), { headers: { 'Authorization': 'Bearer ' + accessToken } });
            const pData = await res.json();
            vehicleLayer.clearLayers();
            pData.forEach(v => {
                const ln = v.line.designation || v.line.shortName || "";
                if (ln === "1" || ln === "01" || parseInt(ln) === 1) {
                    L.marker([v.latitude, v.longitude], {
                        icon: L.divIcon({ className: '', html: `<div class="bus-marker"><i class="fa-solid fa-bus"></i></div>`, iconSize: [32, 32], iconAnchor: [16, 16] })
                    }).addTo(vehicleLayer);
                }
            });
        } catch(e) {}

        // Simonsland
        try {
            const resS = await fetch(PROXY + encodeURIComponent(`https://ext-api.vasttrafik.se/pr/v4/stop-areas/9021014082035000/departures?limit=30`), { headers: { 'Authorization': 'Bearer ' + accessToken } });
            const dS = await resS.json();
            const fill = (plat, id) => {
                let h = ""; let c = 0;
                dS.results?.forEach(i => {
                    if (i.stopPoint?.platform?.trim().toUpperCase() === plat && c < 5) {
                        const diff = Math.round((new Date(i.estimatedTime || i.plannedTime) - new Date()) / 60000);
                        h += `<div class="departure-row"><div class="line-badge" style="background:${i.serviceJourney.line.backgroundColor || '#333'}">${i.serviceJourney.line.shortName}</div><div class="dest-wrapper"><div class="destination">MOT ${i.serviceJourney.direction.split(',')[0]}</div><div class="platform">Läge ${i.stopPoint.platform}</div></div><div class="time-area"><span class="eta">${diff <= 0 ? 'NU' : diff}</span></div></div>`;
                        c++;
                    }
                });
                document.getElementById(id).innerHTML = h || "Inga bussar.";
            };
            fill("A", "board-simonsland-in"); fill("B", "board-simonsland-out");
        } catch(e) {}

        // Resecentrum
        let combined = [];
        try {
            const xml = `<REQUEST><LOGIN authenticationkey='${TV_KEY}'/><QUERY objecttype='TrainAnnouncement' schemaversion='1.9' orderby='AdvertisedTimeAtLocation asc'><FILTER><AND><OR><EQ name='LocationSignature' value='Bs'/><EQ name='LocationSignature' value='Bsc'/></OR><EQ name='ActivityType' value='Avgang'/><GT name='AdvertisedTimeAtLocation' value='$dateadd(-00:10:00)'/></AND></FILTER></QUERY></REQUEST>`;
            const resT = await fetch("https://api.trafikinfo.trafikverket.se/v2/data.json", { method: 'POST', body: xml });
            const dataT = await resT.json();
            dataT.RESPONSE.RESULT[0].TrainAnnouncement?.forEach(t => {
                const diff = Math.round((new Date(t.EstimatedTimeAtLocation || t.AdvertisedTimeAtLocation) - new Date()) / 60000);
                let dRaw = t.ToLocation ? t.ToLocation[0].LocationName.toUpperCase() : "OKÄND";
                combined.push({ t: new Date(t.EstimatedTimeAtLocation || t.AdvertisedTimeAtLocation), html: `<div class="departure-row" style="border-right-color:#607d8b"><div class="line-badge" style="background:#607d8b; font-size:0.75rem;">TÅG</div><div class="dest-wrapper"><div class="destination">MOT ${stationMap[dRaw] || dRaw}</div><div class="platform">Spår ${t.TrackAtLocation || '-'}</div></div><div class="time-area"><span class="eta">${diff <= 0 ? 'NU' : diff}</span></div></div>` });
            });

            const resB = await fetch(PROXY + encodeURIComponent(`https://ext-api.vasttrafik.se/pr/v4/stop-areas/9021014082017000/departures?limit=30`), { headers: { 'Authorization': 'Bearer ' + accessToken } });
            const dB = await resB.json();
            dB.results?.forEach(i => {
                const ln = parseInt(i.serviceJourney.line.shortName);
                if ((ln > 31 || isNaN(ln)) && i.serviceJourney.line.transportMode !== 'train') {
                    const diff = Math.round((new Date(i.estimatedTime || i.plannedTime) - new Date()) / 60000);
                    combined.push({ t: new Date(i.estimatedTime || i.plannedTime), html: `<div class="departure-row"><div class="line-badge" style="background:#1D1D1B">${i.serviceJourney.line.shortName}</div><div class="dest-wrapper"><div class="destination">MOT ${i.serviceJourney.direction.split(',')[0]}</div><div class="platform">Läge ${i.stopPoint.platform}</div></div><div class="time-area"><span class="eta">${diff <= 0 ? 'NU' : diff}</span></div></div>` });
                }
            });
            combined.sort((a,b) => a.t - b.t);
            document.getElementById('board-resecentrum').innerHTML = combined.slice(0, 10).map(c => c.html).join('');
        } catch(e) {}
    }

    update();
    setInterval(update, 30000);
</script>
</body>
</html>
