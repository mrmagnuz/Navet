<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NAVET LIVE | GitHub Fix</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --navet-green: #49a441; --navet-dark: #1D1D1B; }
        body { font-family: 'Montserrat', sans-serif; background: #222; color: white; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { padding: 15px; background: #fff; color: #000; display: flex; justify-content: space-between; border-bottom: 4px solid var(--navet-green); }
        .main { flex: 1; display: flex; padding: 10px; gap: 10px; }
        #map { flex: 1; border-radius: 10px; background: #333; }
        .sidebar { width: 350px; display: flex; flex-direction: column; gap: 10px; }
        .board { background: rgba(255,255,255,0.1); border-radius: 8px; padding: 10px; flex: 1; overflow: hidden; }
        .board h2 { margin: 0 0 10px 0; font-size: 1rem; border-bottom: 1px solid #444; padding-bottom: 5px; color: var(--navet-green); }
        #diag-panel { background: #000; color: #0f0; font-family: monospace; padding: 10px; font-size: 0.7rem; max-height: 150px; overflow-y: auto; border-top: 2px solid #333; }
        .log-err { color: #f44; } .log-ok { color: #4f4; }
    </style>
</head>
<body>

<header>
    <div style="font-weight:900">NAVET LIVE-TAVLA</div>
    <div id="clock">00:00</div>
</header>

<div class="main">
    <div id="map"></div>
    <div class="sidebar">
        <div class="board"><h2>SIMONSLAND</h2><div id="board-sim"></div></div>
        <div class="board"><h2>RESECENTRUM</h2><div id="board-res"></div></div>
    </div>
</div>

<div id="diag-panel">
    <div id="log-content">> Väntar på systemstart...</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const V_KEY = 'QlypIiMS1PaWXe5Nu1HWl1bCYU8a';
    const V_SECRET = 'OfZF4rSB2MaWEx1qgTtuMVMue70a';
    
    // Vi testar en annan proxy som ofta fungerar bättre på arbetsplatser
    const PROXY = 'https://corsproxy.io/?'; 

    function log(msg, type = '') {
        const content = document.getElementById('log-content');
        const div = document.createElement('div');
        if(type) div.className = 'log-' + type;
        div.innerText = `> [${new Date().toLocaleTimeString()}] ${msg}`;
        content.prepend(div);
    }

    // Starta klockan
    setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString('sv-SE', {hour:'2-digit', minute:'2-digit'}); }, 1000);

    // Starta kartan
    const map = L.map('map', {zoomControl: false}).setView([57.7243, 12.9370], 15);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

    let accessToken = "";

    async function getToken() {
        log("Testar anslutning via corsproxy.io...");
        try {
            const auth = btoa(V_KEY.trim() + ":" + V_SECRET.trim());
            const url = "https://ext-api.vasttrafik.se/token";
            
            // Vi lägger till en timeout för att se om anropet hänger sig
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), 10000);

            const res = await fetch(PROXY + encodeURIComponent(url), {
                method: 'POST',
                headers: { 
                    'Authorization': 'Basic ' + auth, 
                    'Content-Type': 'application/x-www-form-urlencoded' 
                },
                body: 'grant_type=client_credentials',
                signal: controller.signal
            });

            clearTimeout(id);

            if (res.ok) {
                const data = await res.json();
                accessToken = data.access_token;
                log("INLOGGNING LYCKADES!", "ok");
                update();
            } else {
                log(`Västtrafik svarade fel: ${res.status}`, "err");
            }
        } catch (e) {
            log(`KRITISKT FEL: ${e.message}`, "err");
            if(e.message.includes("abort")) log("Anslutningen tog för lång tid (Timeout).", "err");
            log("Datorn blockerar troligen anropet. Testa att öppna sidan i mobilen (utan wifi).", "warn");
        }
    }

    async function update() {
        if (!accessToken) return;
        try {
            const url = `https://ext-api.vasttrafik.se/pr/v4/stop-areas/9021014082035000/departures?limit=5`;
            const res = await fetch(PROXY + encodeURIComponent(url), {
                headers: { 'Authorization': 'Bearer ' + accessToken }
            });
            if (res.ok) {
                log("Data hämtad!", "ok");
            }
        } catch(e) { log("Kunde inte hämta data.", "err"); }
    }

    getToken();
</script>
</body>
</html>
