<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NAVET LIVE | Produktion</title>
    <link href="https://fonts.googleapis.com/css2?family=Amatic+SC:wght@700&family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --navet-green: #49a441; --navet-dark: #1D1D1B; }
        body { font-family: 'Montserrat', sans-serif; background: #eee url('https://www.navet.com/wp-content/uploads/2023/03/bg3.png') no-repeat center center fixed; background-size: cover; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        header { padding: 10px 40px; display: flex; justify-content: space-between; align-items: center; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); border-bottom: 3px solid var(--navet-green); z-index: 1000; flex-shrink: 0; }
        .header-title { font-size: 1.4rem; font-weight: 900; text-transform: uppercase; }
        #clock { font-size: 2.2rem; font-weight: 900; }
        .main-wrapper { display: flex; flex: 1; padding: 10px 20px; gap: 15px; overflow: hidden; }
        .left-content { flex: 2; display: flex; flex-direction: column; gap: 10px; }
        .simonsland-grid { display: flex; gap: 15px; flex-shrink: 0; }
        #map { flex: 1; border-radius: 15px; border: 3px solid var(--navet-dark); z-index: 1; background: #ddd; }
        .right-content { flex: 1; display: flex; flex-direction: column; }
        .column { display: flex; flex-direction: column; flex: 1; overflow: hidden; }
        .column-header { font-family: 'Amatic SC', cursive; font-size: 1.8rem; text-align: center; background: var(--navet-dark); color: white; padding: 5px; border-radius: 8px 8px 0 0; margin-bottom: 5px; }
        .departure-list { display: flex; flex-direction: column; gap: 4px; padding: 5px; overflow-y: auto; }
        .departure-row { background: rgba(255, 255, 255, 0.95); display: flex; align-items: center; padding: 6px 12px; border-radius: 8px; border-right: 6px solid var(--navet-green); box-shadow: 0 2px 4px rgba(0,0,0,0.1); min-height: 55px; }
        .line-badge { min-width: 45px; height: 45px; display: flex; justify-content: center; align-items: center; font-weight: 900; border-radius: 6px; margin-right: 12px; color: white; background: #333; font-size: 1.1rem; }
        .dest-wrapper { flex-grow: 1; overflow: hidden; }
        .destination { font-size: 0.85rem; font-weight: 800; text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .platform { font-size: 0.75rem; color: #666; font-weight: 700; }
        .time-area { text-align: right; min-width: 60px; }
        .eta { font-size: 1.5rem; font-weight: 900; color: var(--navet-green); line-height: 1; }
        #diag-panel { background: #000; color: #0f0; font-family: monospace; padding: 10px; font-size: 0.75rem; max-height: 100px; overflow-y: auto; flex-shrink: 0; border-top: 2px solid #333; }
        .log-ok { color: #4f4; } .log-err { color: #f44; } .log-warn { color: #ffcc00; }
    </style>
</head>
<body>

<header>
    <div class="header-title">HÅLLPLATSER SIMONSLAND OCH RESECENTRUM</div>
    <div id="clock">00:00</div>
</header>

<div class="main-wrapper">
    <div class="left-content">
        <div class="simonsland-grid">
            <div class="column"><div class="column-header">SIMONSLAND MOT CENTRUM</div><div id="board-simonsland-in" class="departure-list">Söker anslutning...</div></div>
            <div class="column"><div class="column-header">SIMONSLAND MOT KNALLELAND</div><div id="board-simonsland-out" class="departure-list">Söker anslutning...</div></div>
        </div>
        <div id="map"></div>
    </div>
    <div class="right-content">
        <div class="column"><div class="column-header">Resecentrum (Tåg & Region)</div><div id="board-resecentrum" class="departure-list">Söker anslutning...</div></div>
    </div>
</div>

<div id="diag-panel">
    <div id="log-content">> [System] Initierar anslutning...</div>
</div>

<script>
    function updateClock() { document.getElementById('clock').innerText = new Date().toLocaleTimeString('sv-SE', {hour: '2-digit', minute: '2-digit'}); }
    setInterval(updateClock, 1000); updateClock();
</script>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    function log(msg, type = '') {
        const content = document.getElementById('log-content');
        const div = document.createElement('div');
        if(type) div.className = 'log-' + type;
        div.innerText = `> [${new Date().toLocaleTimeString('sv-SE', {hour:'2-digit', minute:'2-digit', second:'2-digit'})}] ${msg}`;
        content.prepend(div);
    }

    // ISOLERAD KARTA: Om brandväggen blockerar kartan kraschar inte resten av systemet
    let map, vehicleLayer;
    try {
        const NAVET = [57.724285, 12.936959];
        const SIMONSLAND = [57.72557, 12.93841];
        const RESECENTRUM = [57.720733, 12.932754];

        map = L.map('map', { zoomControl: false }).setView(NAVET, 15);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
        vehicleLayer = L.layerGroup().addTo(map);

        L.polyline([NAVET, [57.7245, 12.9378], [57.7250, 12.9382], SIMONSLAND], {color: '#1D1D1B', weight: 4, dashArray: '5, 8', opacity: 0.6}).addTo(map);
        L.polyline([NAVET, [57.723437,12.936337], [57.723231,12.936766], [57.722543,12.935414], [57.722016,12.935114], [57.722051,12.934771], [57.72185,12.934277], [57.721134,12.933049], [57.720933,12.932829], RESECENTRUM], {color: '#1D1D1B', weight: 4, dashArray: '5, 8', opacity: 0.6}).addTo(map);
        L.circleMarker(NAVET, { radius: 8, fillColor: "#49a441", color: "#fff", weight: 3, fillOpacity: 1 }).addTo(map).bindTooltip("NAVET", {permanent: true, direction: 'left', offset: [-10, 0]});
        L.circleMarker(SIMONSLAND, { radius: 6, fillColor: "#1D1D1B", color: "#fff", weight: 2, fillOpacity: 1 }).addTo(map).bindTooltip("Simonsland", {permanent: true, direction: 'right'});
        L.circleMarker(RESECENTRUM, { radius: 6, fillColor: "#1D1D1B", color: "#fff", weight: 2, fillOpacity: 1 }).addTo(map).bindTooltip("Resecentrum", {permanent: true, direction: 'left'});
        log("Karta laddad OK.", "ok");
    } catch (e) {
        log("VARNING: Datorns nätverk blockerar kart-biblioteket.", "warn");
    }

    // --- API & LOGIK ---
    const V_KEY = 'QlypIiMS1PaWXe5Nu1HWl1bCYU8a';
    const V_SECRET = 'OfZF4rSB2MaWEx1qgTtuMVMue70a';
    const TV_KEY = '8b529134e7844ac48320577d18d0237e';
    const PROXY_LIST = ['https://corsproxy.io/?', 'https://api.allorigins.win/raw?url='];
    let accessToken = "";

    async function getToken() {
        log("Försöker logga in mot Västtrafik...");
        const auth = btoa(V_KEY.trim() + ":" + V_SECRET.trim());
        const url = "https://ext-api.vasttrafik.se/token";

        for (let proxy of PROXY_LIST) {
            try {
                const res = await fetch(proxy + encodeURIComponent(url), {
                    method: 'POST',
                    headers: { 'Authorization': 'Basic ' + auth, 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'grant_type=client_credentials'
                });

                if (res.ok) {
                    const data = await res.json();
                    accessToken = data.access_token;
                    log("INLOGGNING LYCKADES!", "ok");
                    update();
                    return;
                }
            } catch (e) {}
        }
        log("KRITISKT FEL: Datorns brandvägg blockerar inloggningen (Failed to fetch)", "err");
        log("Öppna din GitHub-länk i mobilen (utan wifi) för att bevisa att koden fungerar.", "warn");
    }

    async function update() {
        if (!accessToken) return;
        let combined = [];
        let tvFound = false;

        // 1. Simonsland
        try {
            const resS = await fetch(PROXY_LIST[1] + encodeURIComponent(`https://ext-api.vasttrafik.se/pr/v4/stop-areas/9021014082035000/departures?limit=50&timeSpan=1440&maxDeparturesPerLineAndDirection=4`), { headers: { 'Authorization': 'Bearer ' + accessToken } });
            if(resS.ok) {
                const dataS = await resS.json();
                const render = (plat, id) => {
                    let h = ""; let c = 0;
                    dataS.results?.forEach(d => {
                        if (d.stopPoint?.platform?.trim().toUpperCase() === plat && c < 4) { h += createRow(d, false); c++; }
                    });
                    document.getElementById(id).innerHTML = h || "Inga bussar just nu.";
                };
                render("A", "board-simonsland-in");
                render("B", "board-simonsland-out");
            }
        } catch(e) {}

        // 2. Tåg
        try {
            const xml = `<REQUEST><LOGIN authenticationkey='${TV_KEY}'/><QUERY objecttype='TrainAnnouncement' schemaversion='1.9' orderby='AdvertisedTimeAtLocation asc'><FILTER><AND><OR><EQ name='LocationSignature' value='Bs'/><EQ name='LocationSignature' value='Bsc'/></OR><EQ name='ActivityType' value='Avgang'/><GT name='AdvertisedTimeAtLocation' value='$dateadd(-00:10:00)'/></AND></FILTER></QUERY></REQUEST>`;
            const resT = await fetch("https://api.trafikinfo.trafikverket.se/v2/data.json", { method: 'POST', headers: { 'Content-Type': 'text/xml' }, body: xml });
            if (resT.ok) {
                const dataT = await resT.json();
                const trains = dataT.RESPONSE.RESULT[0].TrainAnnouncement;
                tvFound = trains && trains.length > 0;
                trains?.forEach(t => {
                    combined.push({ t: new Date(t.EstimatedTimeAtLocation || t.AdvertisedTimeAtLocation), html: createTrainRow(t), isTrain: true });
                });
            }
        } catch(e) {}

        // 3. Regionbussar
        try {
            const resB = await fetch(PROXY_LIST[1] + encodeURIComponent(`https://ext-api.vasttrafik.se/pr/v4/stop-areas/9021014082017000/departures?limit=50&timeSpan=1440`), { headers: { 'Authorization': 'Bearer ' + accessToken } });
            if(resB.ok) {
                const dataB = await resB.json();
                dataB.results?.forEach(d => {
                    const ln = d.serviceJourney?.line?.shortName;
                    if ((parseInt(ln) > 31 || isNaN(parseInt(ln))) && (d.serviceJourney?.line?.transportMode !== 'train' || !tvFound)) {
                        combined.push({ t: new Date(d.estimatedTime || d.plannedTime), html: createRow(d, false), isTrain: false });
                    }
                });
            }
        } catch(e) {}

        combined.sort((a,b) => a.t - b.t);
        let rHtml = ""; let rCount = 0;
        combined.forEach(item => {
            if (item.t > new Date(Date.now() - 60000) && rCount < 12) { rHtml += item.html; rCount++; }
        });
        document.getElementById('board-resecentrum').innerHTML = rHtml || "Inga avgångar.";

        // 4. Fordon på karta
        if (vehicleLayer) {
            try {
                const resP = await fetch(PROXY_LIST[1] + encodeURIComponent('https://ext-api.vasttrafik.se/pr/v4/positions?lowerLeftLat=57.65&lowerLeftLong=12.85&upperRightLat=57.78&upperRightLong=13.05'), { headers: { 'Authorization': 'Bearer ' + accessToken } });
                if(resP.ok) {
                    const pData = await resP.json();
                    vehicleLayer.clearLayers();
                    pData.forEach(v => {
                        if (v.latitude && v.line) {
                            const ln = v.line.shortName || v.line.designation || "?";
                            const isR = parseInt(ln) > 31 || isNaN(parseInt(ln));
                            L.marker([v.latitude, v.longitude], {
                                icon: L.divIcon({ className: '', html: `<div style="background:${isR ? "#1D1D1B" : (v.line.backgroundColor || '#49a441')}; color:white; width:22px; height:22px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:9px; font-weight:900; border:2px solid white;">${ln}</div>` })
                            }).addTo(vehicleLayer);
                        }
                    });
                }
            } catch(e) {}
        }
        log("Data uppdaterad.", "ok");
    }

    function createRow(d, isT) {
        const diff = Math.round((new Date(d.estimatedTime || d.plannedTime) - new Date()) / 60000);
        const ln = d.serviceJourney.line.shortName || 'BUS';
        const isR = parseInt(ln) > 31 || isNaN(parseInt(ln));
        const bg = isT ? "#607d8b" : (isR ? "#1D1D1B" : (d.serviceJourney.line.backgroundColor || "#333"));
        return `<div class="departure-row" ${isT ? 'style="border-right-color:#607d8b"' : ''}>
            <div class="line-badge" style="background:${bg}">${ln}</div>
            <div class="dest-wrapper"><div class="destination">MOT ${d.serviceJourney.direction?.split(',')[0] || 'OKÄND'}</div><div class="platform">${isT ? 'Spår' : 'Läge'} ${d.stopPoint?.platform || '-'}</div></div>
            <div class="time-area"><span class="eta">${diff <= 0 ? 'NU' : diff}</span>${diff > 0 ? '<span style="font-size:0.6rem;display:block">MIN</span>' : ''}</div>
        </div>`;
    }

    function createTrainRow(t) {
        const diff = Math.round((new Date(t.EstimatedTimeAtLocation || t.AdvertisedTimeAtLocation) - new Date()) / 60000);
        const m = { 'G': 'GÖTEBORG C', 'HR': 'HERRLJUNGA', 'HRC': 'HERRLJUNGA', 'VV': 'VARBERG', 'VBC': 'VARBERG', 'BA': 'BORÅS C', 'BS': 'BORÅS C' };
        let dest = t.ToLocation ? (m[t.ToLocation[0].LocationName.toUpperCase()] || t.ToLocation[0].LocationName) : "OKÄND";
        return `<div class="departure-row" style="border-right-color:#607d8b">
            <div class="line-badge" style="background:#607d8b; font-size:0.75rem;">TÅG</div>
            <div class="dest-wrapper"><div class="destination">MOT ${dest}</div><div class="platform">Spår ${t.TrackAtLocation || '-'}</div></div>
            <div class="time-area"><span class="eta">${diff <= 0 ? 'NU' : diff}</span>${diff > 0 ? '<span style="font-size:0.6rem;display:block">MIN</span>' : ''}</div>
        </div>`;
    }

    getToken();
    setInterval(update, 60000);
</script>
</body>
</html>
